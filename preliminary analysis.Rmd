---
title: "Preliminary_analysis"
author: "Keith Hankowsky"
date: "2/8/2022"
output: html_document
---

```{r}
library(tidyverse)
library(readxl)
library(janitor)
library(skimr)
library(data.table)
library(fuzzyjoin)
library(lubridate)
library(kableExtra)

library(maps) # land masses
library(rgdal) # read OGR vector maps into Spatial objects
library(viridis) # for customizing scale bars
library(mapproj)
library(hexbin)
library(sf)
library(scales)
library(beepr)
```



# Import Data
## Study fleet data
```{r}
#importing the study fleet data
study_fleet <- read_csv('./data/STUDY_FLEET_GROUNFISH_DATA_PULL_V1.csv')
```



## Observer data
```{r}
observer1 <- read_excel('./data/result1.xlsx')
observer2 <- read_excel('./data/result2.xlsx', col_names = FALSE)


observer_colnames <- as.vector(colnames(observer1))

names(observer2) <- observer_colnames

skim(observer1)

observer2 <- observer2 %>%
  mutate(PERMIT1 = as.logical(PERMIT1), 
         GIS_LATHBEG = as.double(GIS_LATHBEG), 
         GIS_LONHBEG = as.double(GIS_LONHBEG),
         GIS_LATHEND = as.double(GIS_LATHEND), 
         GIS_LONHEND = as.double(GIS_LONHEND), 
         NSWEEPS = as.logical(NSWEEPS), 
         SWEEPDIA = as.logical(SWEEPDIA), 
         LINERMSIZE = as.logical(LINERMSIZE), 
         CODMSIZE = as.logical(CODMSIZE),
         MARKET = as.logical(MARKET), 
         MSWGTAVG = as.double(MSWGTAVG), 
         SOAKDUR = as.double(SOAKDUR), 
         HAULDUR = as.double(HAULDUR), 
         HAILWT = as.double(HAILWT), 
         LIVE_WT = as.double(LIVE_WT)
         )

#bind the two sheets together
observer <- bind_rows(observer1, observer2)

#clear environment of unnecessary datasets
rm(observer1)
rm(observer2)

```



## NEFSC survey data
```{r}
#importing and joining the spring nefsc survey catch and station data and joining them 
nefsc_station_spring <- read_csv('./data/22561_UNION_FSCS_SVSTA_spring.csv')

nefsc_catch_spring <- read_csv('./data/22561_UNION_FSCS_SVCAT_spring.csv')

nefsc_spring <- left_join(nefsc_station_spring, nefsc_catch_spring, 
                           by = c("ID", "CRUISE6", "STRATUM", "TOW", "STATION"))


#importing and joining the fall nefsc survey catch and station data and joining them 
nefsc_station_fall <- read_csv('./data/22560_UNION_FSCS_SVSTA_fall.csv')

nefsc_catch_fall <- read_csv('./data/22560_UNION_FSCS_SVCAT_fall.csv')
  
nefsc_fall <- left_join(nefsc_station_fall, nefsc_catch_fall, 
                           by = c("ID", "CRUISE6", "STRATUM", "TOW", "STATION"))




#joining the spring and fall survey datasets 
nefsc <- rbind(nefsc_spring, nefsc_fall)


rm(nefsc_station_spring)
rm(nefsc_catch_spring)
rm(nefsc_spring)
rm(nefsc_station_fall)
rm(nefsc_catch_fall)
rm(nefsc_fall)
```



## Data for maps
```{r}
#Additional Data for Maps
#Statistical Areas
sareas <- st_read(dsn = "./data/Statistical_Areas_2010_withNames") %>%
  st_set_crs(4269)
sareas <- sareas %>% filter(Id %in% c("464", "465", "511", "512", "513", "514", "515", "521", "522", "525", "526", "537", "538", "539", "551", "561", "562", "611", "612", "613", "543", "542", "541", "534", "533", "616", "615", "614", "621", "622", "623", "624"))  
centroids <- sf::st_coordinates(st_centroid(sareas)) 
areas <- cbind(sareas, centroids)


#Land Mass
states <- map_data("state")
NEUS <- subset(states, region %in% c("Maine", "massachusetts", "new hampshire", "vermont", "maine", "rhode island",
                "connecticut","new york","new jersey","delaware","pennsylvania",
                            "maryland","virginia","north carolina","west virginia"))


#NEFSC Survey Strata
sf::sf_use_s2(FALSE)
nefsc_strata <- st_read(dsn = "./data/strata") %>%
  st_set_crs(4269)


```



# Filtering
## Filtering datasets for just trawl gears and after 2009
```{r}
#filtering the study fleet dataset to include only trawl gears and only after 2009
sf_trawl <- study_fleet %>%
  filter(VTR_GEAR_CODE %in% c('OHS', 'OTF', 'OTO', 'OTR')) %>%
      #OHS - otter trawl, haddock separator
      #OTF - otter trawl, bottom, fish 
      #OTM - otter trawl, midwater
      #OTO - otter trawl, bottom, other
      #OTR - otter trawl, ruhle 
      #OTS - otter trawl, bottom, shrimp
  filter(YEAR >= 2009) %>%
  mutate(survey_comercial_ID = 2)



#filter the observer data set to include only trawl gears and only after 2009
observer_trawl <- observer %>%
  filter(NEGEAR %in% c("050", "057", "150")) %>%
      #050 - Trawl, Otter, Bottom, Fish
      #057 - Trawl, Otter, Bottom, Haddock Separator
      #150 - Trawl, Otter, Bottom, Large Mesh Belly Panel
  filter(YEARHBEG  >= 2009) %>%
  mutate(survey_comercial_ID = 3)

  
  
#filtering the nefsc survey dataset to only after 2009 because of the shift to the bigelow 
nefsc <- nefsc %>%
  mutate(cruise_station_ID = paste(CRUISE6,STATION, sep = '_')) %>%
  relocate(cruise_station_ID) %>%
  filter(EST_YEAR >= 2009) %>%
  mutate(BEGIN_EST_TOWDATE = as.POSIXct(BEGIN_EST_TOWDATE, format = "%m/%d/%y %H:%M")) %>%
  mutate(END_EST_TOWDATE = as.POSIXct(END_EST_TOWDATE, format = "%m/%d/%y %H:%M")) %>%
  mutate(BEGIN_GMT_TOWDATE = as.POSIXct(BEGIN_GMT_TOWDATE, format = "%m/%d/%y %H:%M")) %>%
  mutate(END_GMT_TOWDATE = as.POSIXct(END_GMT_TOWDATE, format = "%m/%d/%y %H:%M")) %>%
  mutate(survey_commerical_ID = 1)


rm(study_fleet)

```






## Slimming datasets
```{r}
#selecting just the variables of interest for each dataset 
sf_trawl_slim <- sf_trawl %>%
  select(c("TRIP_ID", "VESSEL_NAME", "TARGET_SPECIES", "VTR_GEAR_CODE", 
           "EFFORT_ID", "COMMON_NAME", "NESPP4", "SPECIES_ITIS",
           "DISPOSITION_DESCR", "AREA_CODE", "SOAK_DUR_HRS", "EFFORT_NUM",
           "START_HAUL_DATE_GMT", "END_SET_DATE_GMT", "START_HAUL_LAT",
           "START_HAUL_LON", "END_SET_LAT", "END_SET_LON", "DEPTH_FTH", 
           "GEAR_QUANTITY", "GEAR_SIZE", "MESH_SIZE", "MESH_TYPE", 
           "HAIL_AMOUNT", "HAIL_AMOUNT_LB", "CALC_DUR_HR", "CALC_DIST_NM", 
           "MEAN_DPTH_M", "survey_comercial_ID")) %>%
  # select(-c("VES_NAME", "HULL_ID", "PPORT", "HPORT", "ACCSP_GEAR_CODE", 
  #           "PPST", "SAIL_PORT_NAME", "SAIL_STATE_POSTAL", "LAND_PORT_NAME", 
  #           "LAND_STATE_POSTAL", "START_SET_DATE_GMT", "START_SET_LAT", "START_SET_LON", 
  #           "END_HAUL_DATE_GMT")) %>%
  rename(START_TOW_DATE_GMT = START_HAUL_DATE_GMT) %>%
  rename(END_TOW_DATE_GMT = END_SET_DATE_GMT) %>%
  rename(START_TOW_LAT = START_HAUL_LAT) %>% 
  rename(START_TOW_LON = START_HAUL_LON) %>%
  rename(END_TOW_LAT = END_SET_LAT) %>%
  rename(END_TOW_LON = END_SET_LON) %>%
  drop_na(END_TOW_LAT) %>%
  drop_na(END_TOW_LON)
  


#selecting just the variables of interest for each dataset 
ob_trawl_slim <- observer_trawl %>%
  mutate(START_TOW_DATE = make_date(YEARHBEG, MONTHHBEG, DAYHBEG)) %>%
  select(c("START_TOW_DATE", "AREA", "NEGEAR", "GEARNM", "NETNAME", "NETTYPE", 
         "GRCABTYP", "BRDLGTYP", "BRDLGTYP", "FTROPTYP", "CODLINERUSD", "NESPP4", 
         "COMNAME", "CATDISP", "FISHDISP", "FISHDISPDESC", "GIS_LATHBEG", 
         "GIS_LONHBEG", "GIS_LATHEND", "GIS_LONHEND", "HAULDUR", "HAILWT", 
         "LIVE_WT", "survey_comercial_ID")) %>%
  # rename(END_TOW_DATE_GMT = END_SET_DATE_GMT) %>%
    #no end date information in the observer dataset 
  rename(START_TOW_LAT = GIS_LATHBEG) %>% 
  rename(START_TOW_LON = GIS_LONHBEG) %>%
  rename(END_TOW_LAT = GIS_LATHEND) %>%
  rename(END_TOW_LON = GIS_LONHEND) %>%
  drop_na(END_TOW_LAT) %>%
  drop_na(END_TOW_LON)



nefsc_slim <- nefsc %>%
  select(c("cruise_station_ID", "STRATUM", "AREA", "SVGEAR", 
           "BEGIN_GMT_TOWDATE", "END_GMT_TOWDATE", "DECDEG_BEGLAT", 
           "DECDEG_BEGLON", "DECDEG_ENDLAT", "DECDEG_ENDLON", 
           "TOWDUR", "AVGDEPTH", "LOGGED_SPECIES_NAME", "SVSPP", 
           "EXPCATCHNUM", "EXPCATCHWT")) %>%
  # select(-c("EST_MONTH","EST_DAY", "EST_JULIAN_DAY", "BEGLAT", "BEGLON", "ENDLAT", 
  #           "ENDLON", "COURSE", "RPM", "DOPDISTW", "...11", "...12", 
  #           "BEGIN_EST_TOWDATE", "END_EST_TOWDATE", "SURFSALIN", "SURFTEMP", 
  #           "XBT", "BKTTEMP", "SWELLHGT", "SWELLDIR", "WAVEHGT", "WEATHER", 
  #           "WINDSP", "WINDDIR", "BAROPRESS", "CLOUD", "AIRTEMP", "DESSPEED", "DOPDISTB", 
  #           "HEADING", "PITCH")) %>%
  rename(START_TOW_DATE_GMT = BEGIN_GMT_TOWDATE) %>%
  rename(END_TOW_DATE_GMT = END_GMT_TOWDATE) %>%
  rename(START_TOW_LAT = DECDEG_BEGLAT) %>%
  rename(START_TOW_LON = DECDEG_BEGLON) %>%
  rename(END_TOW_LAT = DECDEG_ENDLAT) %>%
  rename(END_TOW_LON = DECDEG_ENDLON) %>%
  drop_na(END_TOW_LAT) %>%
  drop_na(END_TOW_LON)
  


#creating a dataset for just the station inf
# nefsc_station <- rbind(nefsc_station_fall, nefsc_station_spring)
# nefsc_station <- nefsc_station %>%
#   mutate(cruise_station_ID = paste(CRUISE6,STATION, sep = '_')) %>%
#   relocate(cruise_station_ID) %>%
#   filter(EST_YEAR >= 2009) %>%
#   mutate(BEGIN_EST_TOWDATE = as.POSIXct(BEGIN_EST_TOWDATE, format = "%m/%d/%y %H:%M")) %>%
#   mutate(END_EST_TOWDATE = as.POSIXct(END_EST_TOWDATE, format = "%m/%d/%y %H:%M")) %>%
#   mutate(BEGIN_GMT_TOWDATE = as.POSIXct(BEGIN_GMT_TOWDATE, format = "%m/%d/%y %H:%M")) %>%
#   mutate(END_GMT_TOWDATE = as.POSIXct(END_GMT_TOWDATE, format = "%m/%d/%y %H:%M")) %>%
#   mutate(survey_commerical_ID = 1) %>%
# 
#   select(c("cruise_station_ID", "STRATUM", "AREA", "SVGEAR", 
#            "BEGIN_GMT_TOWDATE", "END_GMT_TOWDATE", "DECDEG_BEGLAT", 
#            "DECDEG_BEGLON", "DECDEG_ENDLAT", "DECDEG_ENDLON", 
#            "TOWDUR", "AVGDEPTH")) %>%
#   rename(START_TOW_DATE_GMT = BEGIN_GMT_TOWDATE) %>%
#   rename(END_TOW_DATE_GMT = END_GMT_TOWDATE) %>%
#   rename(START_TOW_LAT = DECDEG_BEGLAT) %>%
#   rename(START_TOW_LON = DECDEG_BEGLON) %>%
#   rename(END_TOW_LAT = DECDEG_ENDLAT) %>%
#   rename(END_TOW_LON = DECDEG_ENDLON) %>%
#   drop_na(END_TOW_LAT) %>%
#   drop_na(END_TOW_LON)

```


## CPUE calulations 
```{r}
#creating a tow duration variable and a total cpue per tow variable for study fleet tows 
sf_trawl_slim <- sf_trawl_slim %>%
  mutate(sf_towdur = difftime(START_TOW_DATE_GMT, END_TOW_DATE_GMT, units = "mins")) %>%
  mutate(sf_towdur = as.double(sf_towdur)) %>%
  drop_na(HAIL_AMOUNT_LB) %>%
  group_by(EFFORT_ID) %>%
  mutate(sf_total_hail = sum(HAIL_AMOUNT_LB)) %>%
  mutate(sf_total_cpue = sf_total_hail/sf_towdur) %>%
  ungroup()


#creating a species cpue per tow variable for study fleet tows 
sf_trawl_slim <- sf_trawl_slim %>%
  group_by(EFFORT_ID, COMMON_NAME) %>%
  mutate(sf_species_hail = sum(HAIL_AMOUNT_LB)) %>%
  mutate(sf_species_cpue = sf_species_hail/sf_towdur) %>%
  ungroup()


#creating a total cpue per tow variable for nefsc tows 
nefsc_slim <- nefsc_slim %>%
  drop_na(EXPCATCHWT) %>%
  group_by(cruise_station_ID) %>%
  mutate(nefsc_total_catch = sum(EXPCATCHWT)) %>%
  mutate(nefsc_total_cpue = nefsc_total_catch/TOWDUR) %>%
  ungroup()


#creating a species cpue per tow variable for nefsc tows 
nefsc_slim <- nefsc_slim %>%
  group_by(cruise_station_ID, SVSPP) %>%
  mutate(nefsc_species_catch = sum(EXPCATCHWT)) %>%
  mutate(nefsc_species_cpue = nefsc_species_catch/TOWDUR) %>%
  ungroup()
  



```



## Assigning Survey Strata to Commercial Tows 
```{r}
#trying to determine which survey strata the commercial/VW tows occurred in 
#using the midpoint of the tow as the determining criteria
#move this section into the import_clean_skim if able to get it working properly
sf_trawl_slim <- sf_trawl_slim %>%
  drop_na(c(START_TOW_LAT, END_TOW_LAT, START_TOW_LON, END_TOW_LON)) %>%
  mutate(midpoint_lat = rowMeans(across(c(START_TOW_LAT, END_TOW_LAT)))) %>%
  mutate(midpoint_long = rowMeans(across(c(START_TOW_LON, END_TOW_LON))))


ob_trawl_slim <- ob_trawl_slim %>%
  drop_na(c(START_TOW_LAT, END_TOW_LAT, START_TOW_LON, END_TOW_LON)) %>%
  mutate(midpoint_lat = rowMeans(across(c(START_TOW_LAT, END_TOW_LAT)))) %>%
  mutate(midpoint_long = rowMeans(across(c(START_TOW_LON, END_TOW_LON))))

vw_slim <- vw_slim %>%
  drop_na(c(START_TOW_LAT, END_TOW_LAT, START_TOW_LON, END_TOW_LON)) %>%
  mutate(midpoint_lat = rowMeans(across(c(START_TOW_LAT, END_TOW_LAT)))) %>%
  mutate(midpoint_long = rowMeans(across(c(START_TOW_LON, END_TOW_LON))))



#converting the midpoint lat/long into a geometry field for sf package 
sf_trawl_slim_sf <- st_as_sf(sf_trawl_slim, coords = c("midpoint_long", "midpoint_lat"), 
                             crs = st_crs(nefsc_strata))

ob_trawl_slim_sf <- st_as_sf(ob_trawl_slim, coords = c("midpoint_long", "midpoint_lat"), 
                             crs = st_crs(nefsc_strata))

vw_slim_sf <- st_as_sf(vw_slim, coords = c("midpoint_long", "midpoint_lat"), 
                             crs = st_crs(nefsc_strata))



############################## Okay I think I finally got this to work #########################################
sf::sf_use_s2(FALSE)
nefsc_strata <- st_read(dsn = "./data/strata") %>%
  st_set_crs(4269)

st_make_valid(nefsc_strata)

#selecting just the midpoint values because the geometry field will not be created correctly with all the other variables in the dataset
points <- sf_trawl_slim %>%  
  distinct(EFFORT_ID, .keep_all = TRUE) %>%
  select(midpoint_lat, midpoint_long)


#turning the lat/long variables into 
points_sf <- st_as_sf(points, coords = c("midpoint_long", "midpoint_lat"), 
                             crs = st_crs(nefsc_strata))


#running the actualy intersection of the tows in the strata and creating a column in the points dataset specifying which stratum the tows occured in 
points$strata <- apply(st_contains(nefsc_strata, points_sf, sparse = FALSE), 2, 
               function(col) { 
                  nefsc_strata[which(col), ]$STRATA
               })

#changing the strata column to numeric instead of a list 
points <- points %>%
  mutate(strata = as.numeric(strata))



#left joining the points dataset (with the stratum column) to the OG study fleet trawl dataset by the lat/long columns
sf_trawl_slim_a <- left_join(sf_trawl_slim, points, by = c("midpoint_lat", "midpoint_long"))




################################################################################################################################################## Everything Below this is Failed Attempts ####################################
################################################################################################################

#removing the edges that have an issue
head(nefsc_strata)

nefsc_strata1 <- nefsc_strata %>%
  filter(!STRATA %in% c("520", "804", "470"))

nefsc_strata %>%
  count(STRATA)


#seeing which tows are contained within which survey strata 
overlay <- st_contains(sf_trawl_slim_sf, nefsc_strata)
st_contains(ob_trawl_slim_sf, nefsc_strata)
overlay3 <- st_contains(vw_slim_sf, nefsc_strata)


ggplot() + 
  geom_sf(data = overlay3)




#trying another method I found online 
#NEFSC Survey Strata
sf::sf_use_s2(FALSE)
nefsc_strata <- st_read(dsn = "./data/strata") %>%
  st_set_crs(4269)

st_make_valid(nefsc_strata)


sf_trawl_slim_sf <- st_as_sf(sf_trawl_slim, coords = c("midpoint_long", "midpoint_lat"), 
                             crs = st_crs(nefsc_strata))


sf_trawl_slim <- points_sf %>%
  mutate(intersection = as.integer(st_intersects(geometry, nefsc_strata)), 
         strata = if_else(is.na(intersection), '', nefsc_strata$STRATA[intersection]))

head(sf_trawl_slim_sf)
head(nefsc_strata)

view(sf_trawl_slim_sf)




## fuck this I hate this task 
points <- sf_trawl_slim %>%  
  distinct(EFFORT_ID, .keep_all = TRUE) %>%
  select(midpoint_lat, midpoint_long)

points_sf <- st_as_sf(points, coords = c("midpoint_long", "midpoint_lat"), 
                             crs = st_crs(nefsc_strata))

pnts_sf <- do.call("st_sfc",c(lapply(1:nrow(points), 
function(i) {st_point(as.numeric(points[i, ]))}), list("crs" = 4269))) 

pnts_trans <- st_transform(pnts_sf, 2163) # apply transformation to pnts sf
nefsc_strata_trans <- st_transform(nefsc_strata, 2163)      # apply transformation to polygons sf

points$region <- apply(st_intersects(nefsc_strata, pnts_sf, sparse = FALSE), 2, 
               function(col) { 
                  nefsc_strata[which(col), ]$STRATA
               })

points$strata <- apply(st_intersects(nefsc_strata, points_sf, sparse = FALSE), 2, 
               function(col) { 
                  nefsc_strata[which(col), ]$STRATA
               })


points %>%
  mutate(strata = as.numeric(strata)) %>%
  count(strata)








#trying to a method i found on stack overflow
sf_trawl_slim_sf <- sf_trawl_slim_sf %>%
  add_column(strata = NA)

sf_trawl_trans <- st_transform(sf_trawl_slim_sf, 4269)
nefsc_strata_trans <- st_transform(nefsc_strata, 4269)

sf_trawl_slim_sf$strata <- apply(st_intersects(nefsc_strata_trans, sf_trawl_trans, sparse = FALSE), 2, 
                                 function(col) {
                                   nefsc_strata[which(col),]$STRATA
                                 })



#trying a for loop for this
sf_trawl_slim_strat <- sf_trawl_slim 
for (i in 1:dim(sf_trawl_slim)) {
  if(sf_trawl_slim$midpoint_lat[i] & sf_trawl_slim$midpoint_long[i] sf::st_contains())
}


```




## Estimating Swept Area
```{r}
#All of this is taken from 'FISHING EFFECTS MODEL NORTHEAST REGION - NEFMC (2019)' APPENDIX A 

head(sf_trawl)
  
# DISTANCE
sf_trawl$d_t <- sf_trawl$CALC_DIST_NM #distance towed



# BOARDS Weight of otter trawl doors estimated by regression
sf_trawl$weight <- 70.848 + (1.844 * sf_trawl$GTONS) + (0.5344 * sf_trawl$VHP)
# Width trawl doors (meters) estimated by regression
sf_trawl$width_o <- 0.001 * (1223 + (sf_trawl$weight * 0.8333))
# Angle of attack (radians)
sf_trawl$rad_o <- (2 * pi * 40)/360
# Effective Width of otter board (meters)
sf_trawl$w_o <- sf_trawl$width_o * sin(sf_trawl$rad_o)
# Contact index for otter boards is constant
sf_trawl$c_o <- 1



# CABLES (contact index set below) Width of ground cable (meters) based on regression
sf_trawl$width_c <- 0.3048 * (137.54 + (sf_trawl$LEN * 1.823))
# Angle of attack (radians) of ground cable
sf_trawl$rad_c <- (2 * pi * 15)/360
# Effective width of ground cable (meters)
sf_trawl$w_c <- sf_trawl$width_c * sin(sf_trawl$rad_c)



# SWEEP (contact index set below)
sf_trawl$raw_sweep <- sf_trawl$GEAR_SIZE
sf_trawl$w_s <- 0.43 * sf_trawl$raw_sweep # Effective width of sweep (meters)



# CONTACT INDECIES 
sf_trawl$c_c <- 0.95 #CABLES
sf_trawl$c_s <- 0.9  #SWEEP



sf_trawl$boards <- 2 * sf_trawl$w_o * sf_trawl$c_o # Width of both boards (meters)
sf_trawl$cables <- 2 * sf_trawl$w_c * sf_trawl$c_c # Width of both cables (meters)
sf_trawl$sweep <- sf_trawl$w_s * sf_trawl$c_s # Width of the sweep (meters)
sf_trawl$lin_eff_width <- sf_trawl$boards + sf_trawl$cables + sf_trawl$sweep
sf_trawl$A <- sf_trawl$d_t * (0.001 * sf_trawl$lin_eff_width) # SA without sensitivity (km)

```





# Matchcing Tows

## SF w NEFSC fuzzy join based on prosopsed criteria 
```{r}
rm(sf_trawl)
rm(nefsc)


#Fuzzy joining sf tows that are within 1mi and 1 day of nefsc tows
paired_tows_1mi_24hr <- nefsc_slim %>% 
  fuzzyjoin::geo_inner_join(sf_trawl_slim, by = c("END_TOW_LAT", 
                                                   "END_TOW_LON"),
                           max_dist = 1, unit = "miles") %>%
  mutate(time_dif = difftime(END_TOW_DATE_GMT.x, END_TOW_DATE_GMT.y, units = "hours")) %>%
  filter(time_dif > -24 & time_dif < 24) 
  


#confirming that I have 6 matches 
paired_tows_1mi_24hr %>%
  count(cruise_station_ID)
paired_tows_1mi_24hr %>%
  count(EFFORT_ID)

view(paired_tows_1mi_24hr)



#Fuzzy joining sf tows that are within 5mi and 3 day of nefsc tows
paired_tows_5mi_72hr <- nefsc_slim %>% 
  fuzzyjoin::geo_inner_join(sf_trawl_slim, by = c("END_TOW_LAT", 
                                                   "END_TOW_LON"),
                           max_dist = 5, unit = "miles") %>%
  mutate(time_dif = difftime(END_TOW_DATE_GMT.x, END_TOW_DATE_GMT.y, units = "hours")) %>%
  filter(time_dif > -72 & time_dif < 72)


paired_tows_5mi_72hr %>%
  count(cruise_station_ID)
paired_tows_5mi_72hr %>%
  count(EFFORT_ID)




#Fuzzy joining sf tows that are within 10mi and 5 day of nefsc tows
#this one doesn't run because I don't have enough computing power

# paired_tows_10mi_120hr <- nefsc_slim %>% 
#   fuzzyjoin::geo_inner_join(sf_trawl_slim, by = c("END_TOW_LAT", 
#                                                    "END_TOW_LON"),
#                            max_dist = 10, unit = "miles") %>%
#   mutate(time_dif = difftime(END_TOW_DATE_GMT.x, END_TOW_DATE_GMT.y, units = "hours")) %>%
#   filter(time_dif > -120 & time_dif < 120)
# 
# 
# paired_tows_10mi_120hr %>%
#   count(cruise_station_ID)
# paired_tows_10mi_120hr %>%
#   count(EFFORT_ID)


```





## SF w NEFSC fuzzy join for all combinations of miles/days 
```{r}
####### Run the Fuzzy Join for all combinations of miles/days from 1-8 #########

#Fuzzy joining sf tows that are within 1mi and 1days of nefsc tows
paired_tows_1mi_24hr <- nefsc_slim %>% 
  fuzzyjoin::geo_inner_join(sf_trawl_slim, by = c("END_TOW_LAT", 
                                                   "END_TOW_LON"),
                           max_dist = 1, unit = "miles") %>%
  mutate(time_dif = difftime(END_TOW_DATE_GMT.x, END_TOW_DATE_GMT.y, units = "hours")) %>%
  filter(time_dif > -24 & time_dif < 24)

paired_tows_1mi_24hr %>%
  count(cruise_station_ID)
paired_tows_1mi_24hr %>%
  count(EFFORT_ID)



#Fuzzy joining sf tows that are within 1mi and 2days of nefsc tows
paired_tows_1mi_48hr <- nefsc_slim %>% 
  fuzzyjoin::geo_inner_join(sf_trawl_slim, by = c("END_TOW_LAT", 
                                                   "END_TOW_LON"),
                           max_dist = 1, unit = "miles") %>%
  mutate(time_dif = difftime(END_TOW_DATE_GMT.x, END_TOW_DATE_GMT.y, units = "hours")) %>%
  filter(time_dif > -48 & time_dif < 48)

paired_tows_1mi_48hr %>%
  count(cruise_station_ID)
paired_tows_1mi_48hr %>%
  count(EFFORT_ID)



#Fuzzy joining sf tows that are within 1mi and 3days of nefsc tows
paired_tows_1mi_72hr <- nefsc_slim %>% 
  fuzzyjoin::geo_inner_join(sf_trawl_slim, by = c("END_TOW_LAT", 
                                                   "END_TOW_LON"),
                           max_dist = 1, unit = "miles") %>%
  mutate(time_dif = difftime(END_TOW_DATE_GMT.x, END_TOW_DATE_GMT.y, units = "hours")) %>%
  filter(time_dif > -72 & time_dif < 72)

paired_tows_1mi_72hr %>%
  count(cruise_station_ID)
paired_tows_1mi_72hr %>%
  count(EFFORT_ID)


#Fuzzy joining sf tows that are within 1mi and 4days of nefsc tows
paired_tows_1mi_96hr <- nefsc_slim %>% 
  fuzzyjoin::geo_inner_join(sf_trawl_slim, by = c("END_TOW_LAT", 
                                                   "END_TOW_LON"),
                           max_dist = 1, unit = "miles") %>%
  mutate(time_dif = difftime(END_TOW_DATE_GMT.x, END_TOW_DATE_GMT.y, units = "hours")) %>%
  filter(time_dif > -96 & time_dif < 96)

paired_tows_1mi_96hr %>%
  count(cruise_station_ID)
paired_tows_1mi_96hr %>%
  count(EFFORT_ID)




#Fuzzy joining sf tows that are within 1mi and 5days of nefsc tows
paired_tows_1mi_120hr <- nefsc_slim %>% 
  fuzzyjoin::geo_inner_join(sf_trawl_slim, by = c("END_TOW_LAT", 
                                                   "END_TOW_LON"),
                           max_dist = 1, unit = "miles") %>%
  mutate(time_dif = difftime(END_TOW_DATE_GMT.x, END_TOW_DATE_GMT.y, units = "hours")) %>%
  filter(time_dif > -120 & time_dif < 120)

paired_tows_1mi_120hr %>%
  count(cruise_station_ID)
paired_tows_1mi_120hr %>%
  count(EFFORT_ID)



#Fuzzy joining sf tows that are within 1mi and 6days of nefsc tows
paired_tows_1mi_144hr <- nefsc_slim %>% 
  fuzzyjoin::geo_inner_join(sf_trawl_slim, by = c("END_TOW_LAT", 
                                                   "END_TOW_LON"),
                           max_dist = 1, unit = "miles") %>%
  mutate(time_dif = difftime(END_TOW_DATE_GMT.x, END_TOW_DATE_GMT.y, units = "hours")) %>%
  filter(time_dif > -144 & time_dif < 144)

paired_tows_1mi_144hr %>%
  count(cruise_station_ID)
paired_tows_1mi_144hr %>%
  count(EFFORT_ID) 


#Fuzzy joining sf tows that are within 1mi and 7days of nefsc tows
paired_tows_1mi_168hr <- nefsc_slim %>% 
  fuzzyjoin::geo_inner_join(sf_trawl_slim, by = c("END_TOW_LAT", 
                                                   "END_TOW_LON"),
                           max_dist = 1, unit = "miles") %>%
  mutate(time_dif = difftime(END_TOW_DATE_GMT.x, END_TOW_DATE_GMT.y, units = "hours")) %>%
  filter(time_dif > -168 & time_dif < 168)

paired_tows_1mi_168hr %>%
  count(cruise_station_ID)
paired_tows_1mi_168hr %>%
  count(EFFORT_ID) 



#Fuzzy joining sf tows that are within 1mi and 8days of nefsc tows
paired_tows_1mi_192hr <- nefsc_slim %>% 
  fuzzyjoin::geo_inner_join(sf_trawl_slim, by = c("END_TOW_LAT", 
                                                   "END_TOW_LON"),
                           max_dist = 1, unit = "miles") %>%
  mutate(time_dif = difftime(END_TOW_DATE_GMT.x, END_TOW_DATE_GMT.y, units = "hours")) %>%
  filter(time_dif > -192 & time_dif < 192)

paired_tows_1mi_192hr %>%
  count(cruise_station_ID)
paired_tows_1mi_192hr %>%
  count(EFFORT_ID)

```



## Observer w NEFSC fuzzy join datasets based on proposed criteria 
```{r}
paired_tows_1mi_24hr_ob <- nefsc_slim %>% 
  fuzzyjoin::geo_inner_join(ob_trawl_slim, by = c("END_TOW_LAT", 
                                                   "END_TOW_LON"),
                           max_dist = 1, unit = "miles") %>%
  mutate(time_dif = difftime(START_TOW_DATE_GMT, START_TOW_DATE, units = "days")) %>%
  filter(time_dif > -1 & time_dif < 1)

head(ob_trawl_slim)

```



## VW w NEFSC fuzzy join
```{r}
paired_tows_1mi_192hr <- vw_slim %>% 
  fuzzyjoin::geo_inner_join(nefsc_slim, by = c("END_TOW_LAT", 
                                                   "END_TOW_LON"),
                           max_dist = 8, unit = "miles") %>%
  mutate(time_dif = difftime(END_TOW_DATE_GMT.x, END_TOW_DATE_GMT.y, units = "hours")) %>%
  filter(time_dif > -192 & time_dif < 192)

paired_tows_1mi_192hr %>%
  count(cruise_station_ID)
paired_tows_1mi_192hr %>%
  count(EFFORT_ID)
```





# Species Exploration 
```{r}

#exploring the species that occur in the most tows for 1 mile / 1 day matches
paired_tows_1mi_24hr %>% 
  count(COMMON_NAME, EFFORT_ID) %>%
  count(COMMON_NAME) %>%
  arrange(desc(n))


paired_tows_1mi_24hr %>% 
  count(LOGGED_SPECIES_NAME, cruise_station_ID)  %>%
  count(LOGGED_SPECIES_NAME) %>%
  arrange(desc(n))





#exploring the species that occur in the most tows for 5 mile / 3 day matches
paired_tows_5mi_72hr %>% 
  count(COMMON_NAME, EFFORT_ID) %>%
  count(COMMON_NAME) %>%
  arrange(desc(n))


paired_tows_5mi_72hr %>% 
  count(LOGGED_SPECIES_NAME, cruise_station_ID)  %>%
  count(LOGGED_SPECIES_NAME) %>%
  arrange(desc(n))



#matching species within tows that are matched for 1 mile / 1 day matches
paired_tows_1mi_24hr_spp <- paired_tows_1mi_24hr %>%
  filter(SVSPP == 73 & SPECIES_ITIS == 164712 | #cod 
         SVSPP == 74 & SPECIES_ITIS == 164744 | #haddock
         SVSPP == 75 & SPECIES_ITIS == 164727 | #pollock
         SVSPP == 105 & SPECIES_ITIS == 172909 | #yellowtail flounder
         SVSPP == 102 & SPECIES_ITIS == 172877 | #american plaice
         SVSPP == 107 & SPECIES_ITIS == 172873 | #witch flounder
         SVSPP == 76 & SPECIES_ITIS == 164732  | #white hake
         SVSPP == 108 & SPECIES_ITIS == 172746 | #windowpane
         SVSPP == 106 & SPECIES_ITIS == 172905 | #winter flounder
         SVSPP == 155 & SPECIES_ITIS == 166774 | #acadian redfish
         SVSPP == 101 & SPECIES_ITIS == 172933 | #atlantic halibut   #NE Groundfish spp

    
         SVSPP == 72 & SPECIES_ITIS == 164791 | #silver hake
         SVSPP == 77 & SPECIES_ITIS == 164730 | #red hake
         SVSPP == 78 & SPECIES_ITIS == 164731 | #spotted hake
           
         SVSPP == 103 & SPECIES_ITIS == 172735 | #summer flounder
         SVSPP == 104 & SPECIES_ITIS == 172739 | #fourspot flounder
    
         SVSPP == 197 & SPECIES_ITIS == 164499 | #goosefish
         SVSPP == 15 & SPECIES_ITIS == 160617    #spiny dogfish
        )







###############################################################################
###############################################################################
still playing around with this section 
###############################################################################
###############################################################################

paired_tows_1mi_24hr_spp %>%
  select("cruise_station_ID", "END_TOW_DATE_GMT.x", "LOGGED_SPECIES_NAME", 
         "EXPCATCHWT", "nefsc_species_catch", "nefsc_species_cpue", 
         "VESSEL_NAME", "TARGET_SPECIES", "EFFORT_ID", "COMMON_NAME", 
         "DISPOSITION_DESCR", "END_TOW_DATE_GMT.y", "sf_species_hail", 
         "sf_species_cpue") %>%
  mutate(reltive_efficiency = sf_species_cpue/nefsc_species_cpue)





paired_tows_5mi_72hr %>%
  filter(SVSPP == 104 & SPECIES_ITIS == 172739) %>% #cod 
  count(EFFORT_ID) 

paired_tows_5mi_72hr %>%
  filter(SVSPP == 73 & SPECIES_ITIS == 164712) #cod 


         SVSPP == 74 & SPECIES_ITIS == 164744 | #haddock
         SVSPP == 75 & SPECIES_ITIS == 164727 | #pollock
         SVSPP == 105 & SPECIES_ITIS == 172909 | #yellowtail flounder
         SVSPP == 102 & SPECIES_ITIS == 172877 | #american plaice
         SVSPP == 107 & SPECIES_ITIS == 172873 | #witch flounder
         SVSPP == 76 & SPECIES_ITIS == 164732  | #white hake
         SVSPP == 108 & SPECIES_ITIS == 172746 | #windowpane
         SVSPP == 106 & SPECIES_ITIS == 172905 | #winter flounder
         SVSPP == 155 & SPECIES_ITIS == 166774 | #acadian redfish
         SVSPP == 101 & SPECIES_ITIS == 172933 | #atlantic halibut   #NE Groundfish spp

    
         SVSPP == 72 & SPECIES_ITIS == 164791 | #silver hake
         SVSPP == 77 & SPECIES_ITIS == 164730 | #red hake
         SVSPP == 78 & SPECIES_ITIS == 164731 | #spotted hake
           
         SVSPP == 103 & SPECIES_ITIS == 172735 | #summer flounder
         SVSPP == 104 & SPECIES_ITIS == 172739 | #fourspot flounder
    
         SVSPP == 197 & SPECIES_ITIS == 164499 | #goosefish
         SVSPP == 15 & SPECIES_ITIS == 160617    #spiny dogfish
        )



paired_tows_1mi_24hr %>%
  filter(SVSPP == 73)




SVSPP 
SPECIES_ITIS

paired_tows_5mi_72hr %>%
  filter(SVSPP == 73 & SPECIES_ITIS == 164712) %>% #cod
  ggplot() + 
  aes(x = sf_species_cpue) + 
  geom_histogram()

paired_tows_5mi_72hr %>%
  filter(SVSPP == 73 & SPECIES_ITIS == 164712) %>% #cod
  ggplot() + 
  aes(x = nefsc_species_cpue) + 
  geom_histogram()



paired_tows_5mi_72hr %>%
  filter(SVSPP == 73 & SPECIES_ITIS == 164712) %>% #cod
  mutate(nefsc_species_cpue_LN = log(nefsc_species_cpue)) %>%
  mutate(sf_species_cpue_LN = log(sf_species_cpue)) %>%
  ggplot() + 
  geom_histogram(aes(x = sf_species_cpue_LN, y = ..density..), fill = "red",
                 bins = 183) + 
  geom_label(aes(x = -5, y = 0.5, label = "Study Fleet CPUE"), color = "red") + 
  geom_histogram(aes(x = nefsc_species_cpue_LN, y = -..density..), fill = "blue", 
                 bins = 183) + 
  geom_label(aes(x = -5, y = -1, label = "NEFSC CPUE"), color = "blue") + 
  labs(x = "Ln(CPUE) [lb/min]", y = "Density", 
       title = "Histogram of Ln(CPUE) for Atlantic Cod", 
       subtitle = "Pairs within 5 mi and 72 hrs")




paired_tows_5mi_72hr %>%
  filter(SVSPP == 73 & SPECIES_ITIS == 164712) %>% #cod
  mutate(relative_efficiency = sf_species_cpue/nefsc_species_cpue) %>%
  ggplot() + 
  geom_histogram(aes(x = relative_efficiency), bins = 183) + 
  labs(x = "Relative Efficiency (SF CPUE / NEFSC CPUE)", y = "Count", 
       title = "Histogram of Relative Efficiency for Atlantic Cod", 
       subtitle = "Pairs within 5 mi and 72 hrs")







```








# Data Visualization 
## Map of SF & NEFSC tows independently
```{r}


sf_trawl %>%
  ggplot() + 
  geom_sf(data = areas, fill = "grey") +
  geom_polygon(data = NEUS, aes(x=long, y = lat, group = group), 
               fill = "darkgreen",  color="black",inherit.aes = FALSE)  +
  # geom_point(data = sf_trawl, aes(x = START_HAUL_LON,y = START_HAUL_LAT)) +
  # geom_point(data = sf_trawl, aes(x = END_HAUL_LON,y = END_HAUL_LAT)) +
  geom_segment(data = sf_trawl, aes(x = START_HAUL_LON, xend = END_SET_LON, y = START_HAUL_LAT, 
                                    yend = END_SET_LAT)) +
  coord_sf(ylim = c(39, 44),  xlim = c(-74, -67))



nefsc %>%
  ggplot() + 
  geom_sf(data = areas, fill = "grey") +
  geom_polygon(data = NEUS, aes(x=long, y = lat, group = group), 
               fill = "darkgreen",  color="black",inherit.aes = FALSE)  +
  # geom_point(data = nefsc, aes(x = DECDEG_BEGLON,y = DECDEG_BEGLAT)) +
  # geom_point(data = nefsc, aes(x = DECDEG_ENDLON,y = DECDEG_ENDLAT)) +
  geom_segment(data = nefsc, aes(x = DECDEG_BEGLON, xend = DECDEG_ENDLON, 
                                 y = DECDEG_BEGLAT, yend = DECDEG_ENDLAT), 
               colour = nefsc$EST_YEAR) +
  coord_sf(ylim = c(39, 44),  xlim = c(-74, -67))



```



## Map of Fuzzy joins of SF w NEFSC
```{r}
#map of paired Sf w NEFSC tows within 1 mile and 1 day
paired_tows_1mi_24hr %>%
  ggplot() + 
  geom_sf(data = areas, fill = "grey") +
  geom_polygon(data = NEUS, aes(x=long, y = lat, group = group), 
               fill = "darkgreen", color="black",inherit.aes = FALSE)  +
  geom_point(data = paired_tows_1mi_24hr, aes(x = END_TOW_LON.x,y = END_TOW_LAT.x), col = "red") +
  geom_point(data = paired_tows_1mi_24hr, aes(x = END_TOW_LON.y,y = END_TOW_LAT.y), col = "blue") +
  # geom_segment(data = paired_tows_1mi_24hr, aes(x = START_HAUL_LON, xend = END_SET_LON, 
  #                                               y = START_HAUL_LAT, yend = END_SET_LAT)) +
  coord_sf(ylim = c(38, 44),  xlim = c(-75, -67)) + 
  labs(title = "Study Fleet tows Matched to NEFSC tows", subtitle = "within 1 mi and 24 hrs")



#map of SF w NEFSC tows within 3 mile and 3 day 
paired_tows_5mi_72hr %>%
  ggplot() + 
  geom_sf(data = areas, fill = "grey") +
  geom_polygon(data = NEUS, aes(x=long, y = lat, group = group), fill = "darkgreen",  
               color="black",inherit.aes = FALSE)  +
  geom_point(data = paired_tows_5mi_72hr, aes(x = END_TOW_LON.x,y = END_TOW_LAT.x, 
                                              color = "NEFSC")) +
  geom_point(data = paired_tows_5mi_72hr, aes(x = END_TOW_LON.y,y = END_TOW_LAT.y, 
                                              color = "Study Fleet")) +
  
  # geom_segment(data = paired_tows_1mi_24hr, aes(x = START_TOW_LON.x, xend = END_TOW_LON.x,
  #                                               y = START_TOW_LAT.x, yend = END_TOW_LAT.x)) +
  coord_sf(ylim = c(39, 44),  xlim = c(-74, -66)) + 
  scale_colour_manual("", breaks = c("NEFSC", "Study Fleet"), values = c("red", "blue")) +
  labs(title = "Study Fleet tows Matched to NEFSC tows", subtitle = "within 5 mi and 72 hrs")



#Zooming in on the GOM and looking at tow length for map of SF w NEFSC tows within 3 mile and 3 day 
paired_tows_5mi_72hr %>%
  ggplot() + 
  geom_sf(data = areas, fill = "grey") +
  geom_polygon(data = NEUS, aes(x=long, y = lat, group = group), fill = "darkgreen",  
               color="black",inherit.aes = FALSE)  +
  # geom_point(data = paired_tows_5mi_72hr, aes(x = END_TOW_LON.x,y = END_TOW_LAT.x, 
  #                                             color = "NEFSC")) +
  # geom_point(data = paired_tows_5mi_72hr, aes(x = END_TOW_LON.y,y = END_TOW_LAT.y, 
  #                                             color = "Study Fleet")) +
  geom_segment(data = paired_tows_5mi_72hr, aes(x = START_TOW_LON.x, xend = END_TOW_LON.x,
                                                y = START_TOW_LAT.x, yend = END_TOW_LAT.x, 
                                                color = "NEFSC")) +
  geom_segment(data = paired_tows_5mi_72hr, aes(x = START_TOW_LON.y, xend = END_TOW_LON.y,
                                                y = START_TOW_LAT.y, yend = END_TOW_LAT.y, 
                                                color = "Study Fleet")) +
  coord_sf(ylim = c(41.9, 43.3),  xlim = c(-71, -69.6)) + 
  scale_colour_manual("", breaks = c("NEFSC", "Study Fleet"), values = c("red", "blue"))
  # labs(title = "Study Fleet tows Matched to NEFSC tows", subtitle = "within 5 mi and 72 hrs")



#Zooming in on the GB and looking at tow length for map of SF w NEFSC tows within 3 mile and 3 day 
paired_tows_5mi_72hr %>%
  ggplot() + 
  geom_sf(data = areas, fill = "grey") +
  geom_polygon(data = NEUS, aes(x=long, y = lat, group = group), fill = "darkgreen",  
               color="black",inherit.aes = FALSE)  +
  # geom_point(data = paired_tows_5mi_72hr, aes(x = END_TOW_LON.x,y = END_TOW_LAT.x,
  #                                             color = "NEFSC")) +
  # geom_point(data = paired_tows_5mi_72hr, aes(x = END_TOW_LON.y,y = END_TOW_LAT.y,
  #                                             color = "Study Fleet")) +
  geom_segment(data = paired_tows_5mi_72hr, aes(x = START_TOW_LON.x, xend = END_TOW_LON.x,
                                                y = START_TOW_LAT.x, yend = END_TOW_LAT.x, 
                                                color = "NEFSC")) +
  geom_segment(data = paired_tows_5mi_72hr, aes(x = START_TOW_LON.y, xend = END_TOW_LON.y,
                                                y = START_TOW_LAT.y, yend = END_TOW_LAT.y, 
                                                color = "Study Fleet")) +
  coord_sf(ylim = c(40.5, 42.5),  xlim = c(-69.6, -66)) + 
  scale_colour_manual("", breaks = c("NEFSC", "Study Fleet"), values = c("red", "blue"))
# labs(title = "Study Fleet tows Matched to NEFSC tows", subtitle = "within 5 mi and 72 hrs")



#Zooming in on the SNE and looking at tow length for map of SF w NEFSC tows within 3 mile and 3 day 
paired_tows_5mi_72hr %>%
  ggplot() + 
  geom_sf(data = areas, fill = "grey") +
  geom_polygon(data = NEUS, aes(x=long, y = lat, group = group), fill = "darkgreen",  
               color="black",inherit.aes = FALSE)  +
  # geom_point(data = paired_tows_5mi_72hr, aes(x = END_TOW_LON.x,y = END_TOW_LAT.x, 
  #                                             color = "NEFSC")) +
  # geom_point(data = paired_tows_5mi_72hr, aes(x = END_TOW_LON.y,y = END_TOW_LAT.y, 
  #                                             color = "Study Fleet")) +
  geom_segment(data = paired_tows_5mi_72hr, aes(x = START_TOW_LON.x, xend = END_TOW_LON.x,
                                                y = START_TOW_LAT.x, yend = END_TOW_LAT.x, 
                                                color = "NEFSC")) +
  geom_segment(data = paired_tows_5mi_72hr, aes(x = START_TOW_LON.y, xend = END_TOW_LON.y,
                                                y = START_TOW_LAT.y, yend = END_TOW_LAT.y, 
                                                color = "Study Fleet")) +
  coord_sf(ylim = c(39.5, 41.5),  xlim = c(-72.2, -70.2)) + 
  scale_colour_manual("", breaks = c("NEFSC", "Study Fleet"), values = c("red", "blue"))
# labs(title = "Study Fleet tows Matched to NEFSC tows", subtitle = "within 5 mi and 72 hrs")



#map of paired Sf w NEFSC tows within 7 miles and 120 hrs
paired_tows_7mi_120hr %>%
  ggplot() + 
  geom_sf(data = areas, fill = "grey") +
  geom_polygon(data = NEUS, aes(x=long, y = lat, group = group), fill = "darkgreen",  
               color="black",inherit.aes = FALSE)  +
  geom_point(data = paired_tows_7mi_120hr, aes(x = END_TOW_LON.x,y = END_TOW_LAT.x, 
                                               color = "NEFSC")) +
  geom_point(data = paired_tows_7mi_120hr, aes(x = END_TOW_LON.y,y = END_TOW_LAT.y, 
                                               color = "Study Fleet")) +
  
  # geom_segment(data = paired_tows_1mi_24hr, aes(x = START_TOW_LON.x, xend = END_TOW_LON.x,
  #                                               y = START_TOW_LAT.x, yend = END_TOW_LAT.x)) +
  coord_sf(ylim = c(39, 44),  xlim = c(-74, -66)) + 
  scale_colour_manual("", breaks = c("NEFSC", "Study Fleet"), values = c("red", "blue")) +
  labs(title = "Study Fleet tows Matched to NEFSC tows", 
       subtitle = "within 7 mi and 120 hrs (5 days)")



#map of paired Sf w NEFSC tows within 7 miles and 192 hrs
paired_tows_7mi_192hr %>%
  ggplot() + 
  geom_sf(data = areas, fill = "grey") +
  geom_polygon(data = NEUS, aes(x=long, y = lat, group = group), fill = "darkgreen",  
               color="black",inherit.aes = FALSE)  +
  geom_point(data = paired_tows_7mi_192hr, aes(x = END_TOW_LON.x,y = END_TOW_LAT.x,
                                               color = "NEFSC")) +
  geom_point(data = paired_tows_7mi_192hr, aes(x = END_TOW_LON.y,y = END_TOW_LAT.y, 
                                               color = "Study Fleet")) +
  
  # geom_segment(data = paired_tows_1mi_24hr, aes(x = START_TOW_LON.x, xend = END_TOW_LON.x,
  #                                               y = START_TOW_LAT.x, yend = END_TOW_LAT.x)) +
  coord_sf(ylim = c(39, 44),  xlim = c(-74, -66)) + 
  scale_colour_manual("", breaks = c("NEFSC", "Study Fleet"), values = c("red", "blue")) +
  labs(title = "Study Fleet tows Matched to NEFSC tows", 
       subtitle = "within 7 mi and 192 hrs (8 days)")

```



## Map of Fuzzy joins of SF w NEFSC tows inside NEFSC Survey Strata
```{r}
#map of paired Sf w NEFSC tows within 1 mile and 1 day
paired_tows_1mi_24hr %>%
  ggplot() + 
  geom_sf(data = nefsc_strata, fill = "grey") +
  geom_polygon(data = NEUS, aes(x=long, y = lat, group = group), 
               fill = "darkgreen", color="black",inherit.aes = FALSE)  +
  geom_point(data = paired_tows_1mi_24hr, aes(x = END_TOW_LON.x,y = END_TOW_LAT.x), col = "red") +
  geom_point(data = paired_tows_1mi_24hr, aes(x = END_TOW_LON.y,y = END_TOW_LAT.y), col = "blue") +
  # geom_segment(data = paired_tows_1mi_24hr, aes(x = START_HAUL_LON, xend = END_SET_LON, 
  #                                               y = START_HAUL_LAT, yend = END_SET_LAT)) +
  coord_sf(ylim = c(38, 44),  xlim = c(-75, -67)) + 
  labs(title = "Study Fleet tows Matched to NEFSC tows", subtitle = "within 1 mi and 24 hrs")



#map of SF w NEFSC tows within 3 mile and 3 day 
paired_tows_5mi_72hr %>%
  ggplot() + 
  geom_sf(data = nefsc_strata, fill = "grey") +
  geom_polygon(data = NEUS, aes(x=long, y = lat, group = group), fill = "darkgreen",  
               color="black",inherit.aes = FALSE)  +
  geom_point(data = paired_tows_5mi_72hr, aes(x = END_TOW_LON.x,y = END_TOW_LAT.x, 
                                              color = "NEFSC")) +
  geom_point(data = paired_tows_5mi_72hr, aes(x = END_TOW_LON.y,y = END_TOW_LAT.y, 
                                              color = "Study Fleet")) +
  
  # geom_segment(data = paired_tows_1mi_24hr, aes(x = START_TOW_LON.x, xend = END_TOW_LON.x,
  #                                               y = START_TOW_LAT.x, yend = END_TOW_LAT.x)) +
  coord_sf(ylim = c(39, 44),  xlim = c(-74, -66)) + 
  scale_colour_manual("", breaks = c("NEFSC", "Study Fleet"), values = c("red", "blue")) +
  labs(title = "Study Fleet tows Matched to NEFSC tows", subtitle = "within 5 mi and 72 hrs")



#Zooming in on the GOM and looking at tow length for map of SF w NEFSC tows within 3 mile and 3 day 
paired_tows_5mi_72hr %>%
  ggplot() + 
  geom_sf(data = nefsc_strata, fill = "grey") +
  geom_polygon(data = NEUS, aes(x=long, y = lat, group = group), fill = "darkgreen",  
               color="black",inherit.aes = FALSE)  +
  # geom_point(data = paired_tows_5mi_72hr, aes(x = END_TOW_LON.x,y = END_TOW_LAT.x, 
  #                                             color = "NEFSC")) +
  # geom_point(data = paired_tows_5mi_72hr, aes(x = END_TOW_LON.y,y = END_TOW_LAT.y, 
  #                                             color = "Study Fleet")) +
  geom_segment(data = paired_tows_5mi_72hr, aes(x = START_TOW_LON.x, xend = END_TOW_LON.x,
                                                y = START_TOW_LAT.x, yend = END_TOW_LAT.x, 
                                                color = "NEFSC")) +
  geom_segment(data = paired_tows_5mi_72hr, aes(x = START_TOW_LON.y, xend = END_TOW_LON.y,
                                                y = START_TOW_LAT.y, yend = END_TOW_LAT.y, 
                                                color = "Study Fleet")) +
  coord_sf(ylim = c(41.9, 43.3),  xlim = c(-71, -69.6)) + 
  scale_colour_manual("", breaks = c("NEFSC", "Study Fleet"), values = c("red", "blue"))
  # labs(title = "Study Fleet tows Matched to NEFSC tows", subtitle = "within 5 mi and 72 hrs")



#Zooming in on the GB and looking at tow length for map of SF w NEFSC tows within 3 mile and 3 day 
paired_tows_5mi_72hr %>%
  ggplot() + 
  geom_sf(data = nefsc_strata, fill = "grey") +
  geom_polygon(data = NEUS, aes(x=long, y = lat, group = group), fill = "darkgreen",  
               color="black",inherit.aes = FALSE)  +
  # geom_point(data = paired_tows_5mi_72hr, aes(x = END_TOW_LON.x,y = END_TOW_LAT.x,
  #                                             color = "NEFSC")) +
  # geom_point(data = paired_tows_5mi_72hr, aes(x = END_TOW_LON.y,y = END_TOW_LAT.y,
  #                                             color = "Study Fleet")) +
  geom_segment(data = paired_tows_5mi_72hr, aes(x = START_TOW_LON.x, xend = END_TOW_LON.x,
                                                y = START_TOW_LAT.x, yend = END_TOW_LAT.x, 
                                                color = "NEFSC")) +
  geom_segment(data = paired_tows_5mi_72hr, aes(x = START_TOW_LON.y, xend = END_TOW_LON.y,
                                                y = START_TOW_LAT.y, yend = END_TOW_LAT.y, 
                                                color = "Study Fleet")) +
  coord_sf(ylim = c(40.5, 42.5),  xlim = c(-69.6, -66)) + 
  scale_colour_manual("", breaks = c("NEFSC", "Study Fleet"), values = c("red", "blue"))
# labs(title = "Study Fleet tows Matched to NEFSC tows", subtitle = "within 5 mi and 72 hrs")



#Zooming in on the SNE and looking at tow length for map of SF w NEFSC tows within 3 mile and 3 day 
paired_tows_5mi_72hr %>%
  ggplot() + 
  geom_sf(data = nefsc_strata, fill = "grey") +
  geom_polygon(data = NEUS, aes(x=long, y = lat, group = group), fill = "darkgreen",  
               color="black",inherit.aes = FALSE)  +
  # geom_point(data = paired_tows_5mi_72hr, aes(x = END_TOW_LON.x,y = END_TOW_LAT.x, 
  #                                             color = "NEFSC")) +
  # geom_point(data = paired_tows_5mi_72hr, aes(x = END_TOW_LON.y,y = END_TOW_LAT.y, 
  #                                             color = "Study Fleet")) +
  geom_segment(data = paired_tows_5mi_72hr, aes(x = START_TOW_LON.x, xend = END_TOW_LON.x,
                                                y = START_TOW_LAT.x, yend = END_TOW_LAT.x, 
                                                color = "NEFSC")) +
  geom_segment(data = paired_tows_5mi_72hr, aes(x = START_TOW_LON.y, xend = END_TOW_LON.y,
                                                y = START_TOW_LAT.y, yend = END_TOW_LAT.y, 
                                                color = "Study Fleet")) +
  coord_sf(ylim = c(39.5, 41.5),  xlim = c(-72.2, -70.2)) + 
  scale_colour_manual("", breaks = c("NEFSC", "Study Fleet"), values = c("red", "blue"))
# labs(title = "Study Fleet tows Matched to NEFSC tows", subtitle = "within 5 mi and 72 hrs")
```



## Map of Fuzzy joins of observer w NEFSC tows 
```{r}


```













# Joins that didnt work 
```{r}

fList = list()
for(i in )


for(i in 1:length(nefsc$ID)) {
  






################### Joining Techniques that didn't pan out ####################

#maybe a nested for loop?
for(i in 1:length(nefsc$ID)) {
  for(j in 1:length(sf_trawl$TRIP_ID)) {
    if(nefsc$EST_YEAR[i] == sf_trawl$YEAR) {
    else()
    
    if(nefsc$END_GMT_TOWDATE - sf_trawl$END_SET_DATE_GMT  <24) 
    
    if(nefsc$DECDEG_ENDLAT - sf_trawl$END_SET_LAT < 0.01)
    if(nefsc$DECDEG_ENDLON - sf_trawl$END_SET_LON < 0.01)  
    }
  }
}


#non-equal join using data.table 
#create boundaries (1 day = 86400seconds, 0.01 decdeg = 1.1 km)
sf_trawl[, `:=`(END_SET_DATE_GMT_max = END_SET_DATE_GMT + 86400,
           END_SET_DATE_GMT_min = END_SET_DATE_GMT - 86400,
           END_SET_LAT_max = END_SET_LAT + 0.01,
           END_SET_LAT_min = END_SET_LAT - 0.01,
           END_SET_LON_max = END_SET_LON + 0.01,
           END_SET_LON_min = END_SET_LON - 0.01) ]

#perform non-equi join
nefsc[sf_trawl, on = .( END_GMT_TOWDATE <= END_SET_DATE_GMT_max, 
                  END_GMT_TOWDATE >= END_SET_DATE_GMT_min, 
                  DECDEG_ENDLAT <= END_SET_LAT_max, 
                  DECDEG_ENDLAT >= END_SET_LAT_min, 
                  DECDEG_ENDLON <= END_SET_LON_max, 
                  DECDEG_ENDLON >= END_SET_LON_min ),
     nomatch = 0L]
```

