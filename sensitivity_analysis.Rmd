---
title: "sensitivity_analysis"
output: html_document
date: "2023-03-06"
---

```{r setup, include=FALSE}
library(tidyverse)
library(readxl)
library(janitor)
library(skimr)
library(data.table)
library(fuzzyjoin)
library(lubridate)
library(kableExtra)
library(modEvA)
library(GGally)
library(readr)

library(maps) # land masses
library(rgdal) # read OGR vector maps into Spatial objects
library(viridis) # for customizing scale bars
library(mapproj)
library(hexbin)
library(sf)
library(scales)
library(gridExtra)
library(openxlsx)
library(beepr)
library(purrr)
library(rsq)
library(asht)
library(car)
library(effects)
library(ggpubr)

```


# Functions 
```{r}

#creating a function to filter for the species of interest and create the explanatory variables 
rel_eff_func <- function(x) {
  x <- x %>%
  filter(SVSPP == 73 & SPECIES_ITIS == 164712 | #cod 
         SVSPP == 74 & SPECIES_ITIS == 164744 | #haddock
         SVSPP == 105 & SPECIES_ITIS == 172909 | #yellowtail flounder
         SVSPP == 102 & SPECIES_ITIS == 172877 | #american plaice
         SVSPP == 107 & SPECIES_ITIS == 172873 | #witch flounder
         SVSPP == 106 & SPECIES_ITIS == 172905 | #winter flounder
         SVSPP == 197 & SPECIES_ITIS == 164499   #goosefish
        ) %>%
  drop_na(sf_species_cpua, nefsc_species_cpua_LB) %>%
  filter(CATCHWT_updated > 0) %>%
  filter(sf_species_cpua > 0) %>%
  mutate(old_relative_efficiency = log(sf_species_cpua)/log(nefsc_species_cpua_LB)) %>%
  mutate(relative_efficiency = sf_species_cpua/(nefsc_species_cpua_LB + sf_species_cpua)) %>%
  mutate(mgmt_area = case_when(
    AREA_CODE %in% c(511, 512, 513, 514, 515) ~ "GOM", 
    AREA_CODE %in% c(521, 522, 526, 525, 561, 562, 551, 552) ~ "GB", 
    AREA_CODE %in% c(611, 612, 613, 539, 538, 537) ~ "SNE"
  )) %>%
  mutate(season = case_when(
    month(START_TOW_DATE_GMT.x) %in% c(03, 04, 05) ~ "Spring", 
    month(START_TOW_DATE_GMT.x) %in% c(09, 10, 11) ~ "Fall", 
  )) %>%
  mutate(dayNight = case_when(
    dayNight_sf == "day" & dayNight_nefsc == "day" ~ "day", 
    dayNight_sf == "night" & dayNight_nefsc == "night" ~ "night", 
    dayNight_sf == "day" & dayNight_nefsc == "night" ~ "mismatch",
    dayNight_sf == "night" & dayNight_nefsc == "day" ~ "mismatch", 
  )) %>%
  mutate(towTime = case_when(
    time_dif > 0 ~ "nefsc_first", 
    time_dif < 0 ~ "sf_first"
  )) %>%
  drop_na(AVGDEPTH, BOTTEMP, dayNight, towTime, mgmt_area) %>%
  distinct() 
}



#trying to  create functions because I will be running the same models for every species dataset 
covars <- c("season", "mgmt_area", "AVGDEPTH", "BOTTEMP", "dayNight", "towTime")
combos <- purrr::map(1:6, ~as.data.frame(t(combn(covars, .x))))

formulae <- combos %>%
  map_dfr(unite, col="formula", sep = " + ") %>%
  mutate(formula = paste0("relative_efficiency ~  VESSEL_NAME +", formula))



#fit models (takes dataset)
fit.models_cod <- function(x, y) {
  y$formula_clean %>% purrr::map( ~glm(.x, family = binomial, data=x))
}


#compare models (takes list of models created by fit.models())
compare.models <- function(x) {
  clean_list_of_models[1:63][1] %>%
  mutate(aic =  purrr::map_dbl(x, AIC)) %>%
  mutate(rsq =  purrr::map_dbl(x, Dsquared)) %>% 
  arrange(desc(aic)) %>%
  mutate(deltaAIC = aic - aic[length(x)]) %>%
  relocate(rsq, .after = deltaAIC) %>%
  mutate(rsq = sprintf("%0.2f", rsq)) %>%
  mutate(aic = sprintf("%1.0f", aic)) %>%
  mutate(deltaAIC = sprintf("%1.0f", deltaAIC)) %>%
  kbl(col.names = (c("Model", "AIC", "deltaAIC","Deviance Explained"))) %>%
  kable_classic("striped", full_width = FALSE)
}


#creating a function to extract the optimal model 
extract_optimal_model <- function(x) {
  formulae %>%
  mutate(aic =  purrr::map_dbl(x, AIC)) %>%
  mutate(rsq =  purrr::map_dbl(x, Dsquared)) %>% 
  arrange(desc(aic)) %>%
  mutate(deltaAIC = aic - aic[count(x)]) %>%
  filter(deltaAIC <= 2) %>%
  arrange(desc(rsq))
}


##############################################################################
#creating a function to filter for the species of interest and create the explanatory variables 
rel_eff_func_ob <- function(x) {
  x <- x %>%
  filter(SVSPP == 73 & NESPP4 == 818 | #cod 
         SVSPP == 74 & NESPP4 == 1477 | #haddock
         SVSPP == 105 & NESPP4 == 1230 | #yellowtail flounder
         SVSPP == 102 & NESPP4 == 1240 | #american plaice
         SVSPP == 107 & NESPP4 == 1220 | #witch flounder
         SVSPP == 106 & NESPP4 == 1200 | #winter flounder
         SVSPP == 197 & NESPP4 == 124    #monkfish
        ) %>%
  drop_na(ob_species_cpua, nefsc_species_cpua_LB) %>%
  filter(CATCHWT_updated > 0) %>%
  mutate(old_relative_efficiency = log(ob_species_cpua)/log(nefsc_species_cpua_LB)) %>%
  mutate(relative_efficiency = ob_species_cpua/(nefsc_species_cpua_LB + ob_species_cpua)) %>%
  mutate(mgmt_area = case_when(
    AREA.x %in% c(511, 512, 513, 514, 515) ~ "GOM", 
    AREA.x %in% c(521, 522, 526, 525, 561, 562, 551, 552) ~ "GB", 
    AREA.x %in% c(611, 612, 613, 539, 538, 537) ~ "SNE"
  )) %>%
  mutate(season = case_when(
    month(START_TOW_DATE_GMT) %in% c(02, 03, 04, 05) ~ "Spring", 
    month(START_TOW_DATE_GMT) %in% c(09, 10, 11) ~ "Fall", 
  )) %>%
  mutate(DayNight = case_when(
    dayNight_ob == "night" & dayNight_nefsc == "night" ~ "Night",
    dayNight_ob == "day" & dayNight_nefsc == "day" ~ "Day",
    dayNight_ob == "night" & dayNight_nefsc =="day" ~ "Mismatch",
    dayNight_ob == "day" & dayNight_nefsc == "night" ~ "Mismatch"
  )) %>%
  mutate(towTime = case_when(
    time_dif > 0 ~ "nefsc_first", 
    time_dif < 0 ~ "sf_first"
  )) %>%
  mutate(trawl_type = as.factor(trawl_type)) %>%
  drop_na(trawl_type) %>%
  drop_na(AVGDEPTH, BOTTEMP, DayNight, towTime) %>%
  distinct()
}


#creating a function for fitting the observer dataset models 
#trying to  create functions because I will be running the same models for every species dataset 
covars_ob <- c("season", "mgmt_area", "AVGDEPTH", "BOTTEMP", "DayNight", "towTime")
combos_ob <- purrr::map(1:6, ~as.data.frame(t(combn(covars_ob, .x))))

formulae_ob <- combos_ob %>%
  map_dfr(unite, col="formula_ob", sep = " + ") %>%
  mutate(formula_ob = paste0("relative_efficiency ~  trawl_type + ", formula_ob))


#fit models (takes dataset)
fit.models_ob <- function(x) {
  formulae_ob$formula_ob %>% purrr::map( ~glm(.x, family = binomial(link='logit'), data=x))
}



###############################################################################
paired_tow_levels <- c("paired_tows_1mi_24hr", "paired_tows_1mi_48hr", 
                       "paired_tows_1mi_72hr", "paired_tows_1mi_96hr", 
                       "paired_tows_1mi_120hr", "paired_tows_1mi_144hr", 
                       "paired_tows_1mi_168hr", "paired_tows_1mi_192hr", 
    
                       "paired_tows_2mi_24hr", "paired_tows_2mi_48hr", 
                       "paired_tows_2mi_72hr", "paired_tows_2mi_96hr", 
                       "paired_tows_2mi_120hr", "paired_tows_2mi_144hr", 
                       "paired_tows_2mi_168hr", "paired_tows_2mi_192hr", 
                       
                       "paired_tows_3mi_24hr", "paired_tows_3mi_48hr", 
                       "paired_tows_3mi_72hr", "paired_tows_3mi_96hr", 
                       "paired_tows_3mi_120hr", "paired_tows_3mi_144hr", 
                       "paired_tows_3mi_168hr", "paired_tows_3mi_192hr", 
                       
                       "paired_tows_4mi_24hr", "paired_tows_4mi_48hr", 
                       "paired_tows_4mi_72hr", "paired_tows_4mi_96hr", 
                       "paired_tows_4mi_120hr", "paired_tows_4mi_144hr", 
                       "paired_tows_4mi_168hr", "paired_tows_4mi_192hr", 
                       
                       "paired_tows_5mi_24hr", "paired_tows_5mi_48hr", 
                       "paired_tows_5mi_72hr", "paired_tows_5mi_96hr", 
                       "paired_tows_5mi_120hr", "paired_tows_5mi_144hr", 
                       "paired_tows_5mi_168hr", "paired_tows_5mi_192hr",
                       
                       "paired_tows_6mi_24hr", "paired_tows_6mi_48hr", 
                       "paired_tows_6mi_72hr", "paired_tows_6mi_96hr", 
                       "paired_tows_6mi_120hr", "paired_tows_6mi_144hr", 
                       "paired_tows_6mi_168hr", "paired_tows_6mi_192hr",
                       
                       "paired_tows_7mi_24hr", "paired_tows_7mi_48hr", 
                       "paired_tows_7mi_72hr", "paired_tows_7mi_96hr", 
                       "paired_tows_7mi_120hr", "paired_tows_7mi_144hr", 
                       "paired_tows_7mi_168hr", "paired_tows_7mi_192hr",
                       
                       "paired_tows_8mi_24hr", "paired_tows_8mi_48hr", 
                       "paired_tows_8mi_72hr", "paired_tows_8mi_96hr", 
                       "paired_tows_8mi_120hr", "paired_tows_8mi_144hr", 
                       "paired_tows_8mi_168hr", "paired_tows_8mi_192hr"
                       )

```

```{r}
#fit models (takes dataset)
fit.models_old <- function(x) {
  formulae$formula %>% purrr::map( ~glm(.x, family = binomial, data=x))
}

#compare models (takes list of models created by fit.models())
compare.models_old <- function(x) {
  formulae %>%
  mutate(aic =  purrr::map_dbl(x, AIC)) %>%
  mutate(rsq =  purrr::map_dbl(x, Dsquared)) %>% 
  arrange(desc(aic)) %>%
  mutate(deltaAIC = aic - aic[length(x)]) %>%
  relocate(rsq, .after = deltaAIC) %>%
  mutate(rsq = sprintf("%0.2f", rsq)) %>%
  mutate(aic = sprintf("%1.0f", aic)) %>%
  mutate(deltaAIC = sprintf("%1.0f", deltaAIC)) %>%
  kbl(col.names = (c("Model", "AIC", "deltaAIC","Deviance Explained"))) %>%
  kable_classic("striped", full_width = FALSE)
}
```




# Running the relative efficiency analysis for all the datasets 
```{r}
#reading in the list of files, and then reading in all the datasets to a list 
filenames <- list.files(path = "data/sf_paired_data", recursive = TRUE, full.names = TRUE)
datasets <- lapply(filenames, read_csv)


#creating a dataset with all the sample size at each match 
datasets_tibble <- as_tibble_col(filenames, column_name = "dataset") %>%
  mutate(dataset = str_sub(dataset, 21, -5))


#running the relative efficiency calculation and filtering 
datasets_re <- lapply(datasets, rel_eff_func)


#adding the individual datasets to the overall dataset 
datasets_tibble <- datasets_tibble %>%
  mutate(data = datasets_re)

```

# Run Sensitivity Analysis for Each Species and for Both Study Fleet and Observer Matches 

# Study Fleet & NEFSC 
## Cod
```{r}
# only the stuff that actually works for cod 
#filtering the datasets for just cod
datasets_tibble_cod <- datasets_tibble %>%
  unnest(data) %>%
  filter(SVSPP == 73 & SPECIES_ITIS == 164712) %>%
  group_by(dataset) %>%
  nest() %>%
  ungroup()


#creating a list of models, and removing models for which there are only one level of the categorical variables and then cleaning up the list of models 
datasets_tibble_cod <- datasets_tibble_cod %>% 
  mutate(list_of_models = rep(list(formulae),64)) %>%
  unnest(data) %>%
  group_by(dataset) %>%
  mutate(mgmt_area_n = n_distinct(mgmt_area), 
            season_n = n_distinct(season), 
            dayNight_n = n_distinct(dayNight), 
            towTime_n = n_distinct(towTime), 
            vessel_n = n_distinct(VESSEL_NAME)) %>%
  nest(data = 2:78) %>%
  ungroup() %>%
  unnest(list_of_models) %>%  
  mutate(mgmt_area_dtc = str_detect(formula, "mgmt_area"), 
         season_dtc = str_detect(formula, "season"), 
         dayNight_dtc = str_detect(formula, "dayNight"), 
         towTime_dtc = str_detect(formula, "towTime")) %>%
  filter(!(mgmt_area_n == 1 & mgmt_area_dtc == TRUE), 
         !(season_n == 1 & season_dtc == TRUE), 
         !(dayNight_n == 1 & dayNight_dtc == TRUE), 
         !(towTime_n == 1 & towTime_dtc == TRUE)) %>%
  mutate(formula = ifelse(vessel_n == 1, (str_replace(formula, "VESSEL_NAME +", "")), formula)) %>%
  mutate(formula_clean = str_replace(formula, "~  \\+", " ~ ")) %>%
  select(dataset, data, formula_clean) %>%
  group_by(dataset) %>%
  nest(list_of_models = formula_clean) %>%
  ungroup()

clean_list_of_models <- datasets_tibble_cod$list_of_models


#fitting all the models to each dataset 
models_all_cod <- mapply(fit.models_cod, datasets_tibble_cod$data, clean_list_of_models)


#comparing all the models for all the datasets 
for (i in 1:64) {
comparison_tables <- clean_list_of_models[[i]] %>%
  mutate(aic =  purrr::map_dbl(models_all_cod[[i]], AIC)) %>%
  mutate(rsq =  purrr::map_dbl(models_all_cod[[i]], Dsquared)) %>% 
  arrange(desc(aic)) %>%
  mutate(deltaAIC = aic - aic[length(models_all_cod[[i]])]) %>%
  relocate(rsq, .after = deltaAIC) %>%
  mutate(rsq = sprintf("%0.2f", rsq)) %>%
  mutate(aic = sprintf("%1.0f", aic)) %>%
  mutate(deltaAIC = sprintf("%1.0f", deltaAIC)) %>%
  kbl(col.names = (c("Model", "AIC", "deltaAIC","Deviance Explained"))) %>%
  kable_classic("striped", full_width = FALSE) %>%
  kable_styling()

print(comparison_tables)

}


#extract the optimal model from each table 
for (i in 1:64) {
optimal_models <- clean_list_of_models[[i]] %>%
  mutate(aic =  purrr::map_dbl(models_all_cod[[i]], AIC)) %>%
  mutate(rsq =  purrr::map_dbl(models_all_cod[[i]], Dsquared)) %>% 
  arrange(desc(aic)) %>%
  mutate(deltaAIC = aic - aic[length(models_all_cod[[i]])]) %>%
  filter(deltaAIC <= 2) %>%
  arrange(desc(rsq))

print(optimal_models)

}


#adding a column to the dataframe of the optimal model formula for each dataset
#doing this by hand because I wanted to inspect the optimal model(selection criteria: parsimony, deltaAIC < 2, highest r2)
datasets_tibble_cod <- datasets_tibble %>%
  mutate(optimal_model = c("relative_efficiency ~ VESSEL_NAME +BOTTEMP + dayNight", 
                           "relative_efficiency ~ VESSEL_NAME +BOTTEMP + dayNight", 
                           "relative_efficiency ~ VESSEL_NAME +BOTTEMP + dayNight", 
                           "relative_efficiency ~ VESSEL_NAME +BOTTEMP + dayNight",
                           "relative_efficiency ~ dayNight", 
                           "relative_efficiency ~ dayNight", 
                           "relative_efficiency ~ VESSEL_NAME +dayNight", 
                           "relative_efficiency ~ VESSEL_NAME +dayNight", 
                           "relative_efficiency ~ VESSEL_NAME +mgmt_area + AVGDEPTH + dayNight", 
                           "relative_efficiency ~ VESSEL_NAME +mgmt_area + AVGDEPTH", 
                           "relative_efficiency ~ VESSEL_NAME +mgmt_area + AVGDEPTH", 
                           "relative_efficiency ~ VESSEL_NAME +season + AVGDEPTH", 
                           "relative_efficiency ~ VESSEL_NAME +season", 
                           "relative_efficiency ~ VESSEL_NAME +season", 
                           "relative_efficiency ~ VESSEL_NAME +season", 
                           "relative_efficiency ~ VESSEL_NAME +season", 
                           "relative_efficiency ~ VESSEL_NAME +mgmt_area + AVGDEPTH + dayNight", 
                           "relative_efficiency ~ VESSEL_NAME +mgmt_area + AVGDEPTH + dayNight",
                           "relative_efficiency ~ VESSEL_NAME +mgmt_area + AVGDEPTH + dayNight", 
                           "relative_efficiency ~ VESSEL_NAME +mgmt_area + AVGDEPTH + dayNight + towTime", 
                           "relative_efficiency ~ VESSEL_NAME +season", 
                           "relative_efficiency ~ VESSEL_NAME +AVGDEPTH + BOTTEMP", 
                           "relative_efficiency ~ VESSEL_NAME +AVGDEPTH + BOTTEMP", 
                           "relative_efficiency ~ VESSEL_NAME +AVGDEPTH", 
                           "relative_efficiency ~ VESSEL_NAME +mgmt_area + AVGDEPTH + dayNight", 
                           "relative_efficiency ~ VESSEL_NAME +mgmt_area + AVGDEPTH + dayNight", 
                           "relative_efficiency ~ VESSEL_NAME +mgmt_area + AVGDEPTH + dayNight", 
                           "relative_efficiency ~ VESSEL_NAME +mgmt_area + AVGDEPTH + dayNight", 
                           "relative_efficiency ~ VESSEL_NAME +dayNight", 
                           "relative_efficiency ~ VESSEL_NAME +AVGDEPTH + BOTTEMP + towTime", 
                           "relative_efficiency ~ VESSEL_NAME +AVGDEPTH + dayNight", 
                           "relative_efficiency ~ VESSEL_NAME +dayNight", 
                           "relative_efficiency ~ VESSEL_NAME +season + mgmt_area + AVGDEPTH", 
                           "relative_efficiency ~ VESSEL_NAME +season + mgmt_area + AVGDEPTH + BOTTEMP", 
                           "relative_efficiency ~ VESSEL_NAME +season + mgmt_area + AVGDEPTH + BOTTEMP", 
                           "relative_efficiency ~ VESSEL_NAME +season + mgmt_area + AVGDEPTH + BOTTEMP", 
                           "relative_efficiency ~ VESSEL_NAME +towTime", 
                           "relative_efficiency ~ VESSEL_NAME +season + AVGDEPTH + BOTTEMP + towTime", 
                           "relative_efficiency ~ VESSEL_NAME +season + BOTTEMP + towTime", 
                           "relative_efficiency ~ VESSEL_NAME +season + BOTTEMP + towTime", 
                           "relative_efficiency ~ VESSEL_NAME +mgmt_area + AVGDEPTH + towTime", 
                           "relative_efficiency ~ VESSEL_NAME +mgmt_area + AVGDEPTH + towTime", 
                           "relative_efficiency ~ VESSEL_NAME +season + mgmt_area + AVGDEPTH + BOTTEMP + towTime", 
                           "relative_efficiency ~ VESSEL_NAME +season + mgmt_area + AVGDEPTH + towTime", 
                           "relative_efficiency ~ VESSEL_NAME +towTime", 
                           "relative_efficiency ~ VESSEL_NAME +season + BOTTEMP", 
                           "relative_efficiency ~ VESSEL_NAME +season + mgmt_area + BOTTEMP", 
                           "relative_efficiency ~ VESSEL_NAME +season + BOTTEMP", 
                           "relative_efficiency ~ VESSEL_NAME +season + AVGDEPTH + BOTTEMP + towTime", 
                           "relative_efficiency ~ VESSEL_NAME +season + mgmt_area + AVGDEPTH + BOTTEMP + towTime",
                           "relative_efficiency ~ VESSEL_NAME +season + AVGDEPTH + BOTTEMP + towTime", 
                           "relative_efficiency ~ VESSEL_NAME +season + AVGDEPTH + BOTTEMP", 
                           "relative_efficiency ~ VESSEL_NAME +AVGDEPTH + BOTTEMP + towTime", 
                           "relative_efficiency ~ VESSEL_NAME +season + BOTTEMP", 
                           "relative_efficiency ~ VESSEL_NAME +season + AVGDEPTH + BOTTEMP", 
                           "relative_efficiency ~ VESSEL_NAME +season + AVGDEPTH + BOTTEMP", 
                           "relative_efficiency ~ VESSEL_NAME +season + AVGDEPTH + BOTTEMP", 
                           "relative_efficiency ~ VESSEL_NAME +season + AVGDEPTH + BOTTEMP", 
                           "relative_efficiency ~ VESSEL_NAME +season + AVGDEPTH + BOTTEMP", 
                           "relative_efficiency ~ VESSEL_NAME +season + AVGDEPTH + BOTTEMP", 
                           "relative_efficiency ~ VESSEL_NAME +AVGDEPTH + towTime", 
                           "relative_efficiency ~ VESSEL_NAME +AVGDEPTH + towTime", 
                           "relative_efficiency ~ VESSEL_NAME +season + BOTTEMP", 
                           "relative_efficiency ~ VESSEL_NAME +season + BOTTEMP"
                           ))


#run the optimal model for each dataset from the data_tibble 
dataset_final_cod <- datasets_tibble_cod %>%
  mutate(model = purrr::map2(optimal_model, data, ~glm(.x, family = binomial, data = .y))) %>%
  mutate(results = purrr::map(model, broom::tidy)) %>%
  mutate(fitted = purrr::map(model, fitted)) %>%
  unnest(fitted) %>%
  group_by(dataset) %>%
  mutate(mean_re = mean(fitted), 
         n = n(), 
         cv = (sd(fitted)/mean(fitted)), 
         se = sd(fitted)/(sqrt(length(fitted)))) %>%
  nest(fitted = fitted) %>%
  relocate(fitted, .after = results)


#reordering the dataset for plots and to better reflect the purpose 
dataset_final_cod <- dataset_final_cod[match(paired_tow_levels, dataset_final_cod$dataset), ]


dataset_final_cod

#plotting the RE estimate and CV and sample size 
dataset_final_cod %>%
  mutate(match_crit = str_sub(dataset, 13)) %>%
  mutate(match_crit = str_replace(match_crit, "_", " & ")) %>%
  ggplot() + 
  geom_point(aes(x = fct_inorder(match_crit), y = mean_re)) + 
  geom_errorbar(aes(x = match_crit, ymin = mean_re - se, ymax = mean_re + se)) + 
  labs(x = "Matching Criteria", y = "Estimated Relative Efficiency ") + 
  coord_flip()

###############################################################################



```


## Haddock 
```{r}
#filtering the datasets for just cod
datasets_tibble_haddock <- datasets_tibble %>%
  unnest(data) %>%
  filter(SVSPP == 74 & SPECIES_ITIS == 164744) %>%
  group_by(dataset) %>%
  nest() %>%
  ungroup()


#fitting all the models to each dataset 
models_all_haddock <- lapply(datasets_tibble_haddock$data, fit.models)


#comparing all the models for all the datasets 
compared_all_haddock <- lapply(models_all_haddock, compare.models)


#extract the optimal model from each table 
optimal_models_haddock <- lapply(models_all_haddock, extract_optimal_model)

optimal_models_haddock


#adding a column to the dataframe of the optimal model formula for each dataset 
datasets_tibble_cod <- datasets_tibble %>%
  mutate(optimal_model = c("relative_efficiency ~ VESSEL_NAME +season + towTime"))


#run the optimal model for each dataset from the data_tibble 
dataset_final_haddock <- datasets_tibble_cod %>%
  mutate(model = purrr::map2(optimal_model, data, ~glm(.x, family = binomial, data = .y))) %>%
  mutate(results = purrr::map(model, broom::tidy)) %>%
  mutate(fitted = purrr::map(model, fitted)) %>%
  unnest(fitted) %>%
  group_by(dataset) %>%
  summarise(mean_re = mean(fitted), 
         n = n(), 
         cv = (sd(fitted)/mean(fitted)))


dataset_final_haddock

###############################################################################
datasets_tibble_haddock %>%
  unnest(data) %>%
  group_by(dataset) %>%
  summarize(mgmt_area_n = n_distinct(mgmt_area), 
            season_n = n_distinct(season), 
            dayNight_n = n_distinct(dayNight), 
            towTime_n = n_distinct(towTime)) 

```




## Witch Flounder 


## Yellowtail Flounder 


## American Plaice 


## Winter Flounder 


## Monkfish 




###############################################################################
########################                            ###########################
###############################################################################

# Running Sensitivity Analysis for Observer Data
```{r}
#reading in the list of files, and then reading in all the datasets to a list 
filenames_ob <- list.files(path = "data/ob_paired_data", recursive = TRUE, full.names = TRUE)
datasets_ob <- lapply(filenames_ob, read_csv)


#creating a dataset with all the sample size at each match 
datasets_tibble_ob <- as_tibble_col(filenames_ob, column_name = "dataset") %>%
  mutate(dataset = str_sub(dataset, 21, -5))

#adding the individual datasets into the datasets_tibble and cleaning up the data
datasets_tibble_ob <- datasets_tibble_ob %>%
  mutate(data = datasets_ob) %>%
  mutate(data = purrr::map(data, rel_eff_func_ob))

```


# Observer & NEFSC 
## Cod
```{r}
datasets_tibble_ob_cod <- datasets_tibble_ob %>%
  unnest(data) %>%
  filter(SVSPP == 73 & NESPP4 == 818) %>%
  group_by(dataset) %>%
  nest() %>%
  ungroup()

#fitting all the models to each dataset 
models_all_ob_cod <- lapply(datasets_tibble_ob_cod$data, fit.models_ob)


###############################################################################
datasets_tibble_ob_cod %>%
  unnest(data) %>%
  group_by(dataset) %>%
  summarize(mgmt_area_n = n_distinct(mgmt_area), 
            season_n = n_distinct(season), 
            dayNight_n = n_distinct(DayNight), 
            towTime_n = n_distinct(towTime)) 

```




## Haddock 


## Witch Flounder 


## Yellowtail Flounder 


## American Plaice 


## Winter Flounder 


## Monkfish 
