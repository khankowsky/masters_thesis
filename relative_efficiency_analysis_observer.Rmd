---
title: "relative_efficiency_analysis_observer"
output: html_document
date: "2022-10-05"
---



```{r, message = FALSE, warning = FALSE}
library(tidyverse)
library(readxl)
library(janitor)
library(skimr)
library(data.table)
library(fuzzyjoin)
library(lubridate)
library(kableExtra)
library(modEvA)

library(maps) # land masses
library(rgdal) # read OGR vector maps into Spatial objects
library(viridis) # for customizing scale bars
library(mapproj)
library(hexbin)
library(sf)
library(scales)
library(gridExtra)
library(openxlsx)
library(beepr)
library(purrr)
library(broom)
library(aod)
library(car)
library(effects)

```

# Read-In the Data
```{r}
paired_tows_1mi_24hr_ob <- read.csv('./data/paired_tows_1mi_24hr_ob.csv')
paired_tows_5mi_72hr_ob <- read.csv('./data/paired_tows_5mi_72hr_ob.csv')
```


# Data for Maps 
```{r, message = FALSE, warning = FALSE}
#Additional Data for Maps
#Statistical Areas
sareas <- st_read(dsn = "./data/Statistical_Areas_2010_withNames") %>%
  st_set_crs(4269)
sareas <- sareas %>% filter(Id %in% c("464", "465", "511", "512", "513", "514", "515", "521", "522", "525", "526", "537", "538", "539", "551", "561", "562", "611", "612", "613", "543", "542", "541", "534", "533", "616", "615", "614", "621", "622", "623", "624"))  
centroids <- sf::st_coordinates(st_centroid(sareas)) 
areas <- cbind(sareas, centroids)


#Land Mass
states <- map_data("state")
NEUS <- subset(states, region %in% c("Maine", "massachusetts", "new hampshire", "vermont", "maine", "rhode island",
                "connecticut","new york","new jersey","delaware","pennsylvania",
                            "maryland","virginia","north carolina","west virginia"))


#NEFSC Survey Strata
sf::sf_use_s2(FALSE)
nefsc_strata <- st_read(dsn = "./data/strata") %>%
  st_set_crs(4269)


```





# Observer and NEFSC Pairs
## 1m and 24hr Paired Tows 
### Comparing CPUA and Relative Efficiency 
```{r}
paired_tows_1mi_24hr_ob_logre <- paired_tows_1mi_24hr_ob %>%
  filter(SVSPP == 73 & NESPP4 == 818 | #cod 
         SVSPP == 74 & NESPP4 == 1477 | #haddock
         SVSPP == 75 & NESPP4 == 2695 | #pollock
         SVSPP == 105 & NESPP4 == 1230 | #yellowtail flounder
         SVSPP == 102 & NESPP4 == 1240 | #american plaice
         SVSPP == 107 & NESPP4 == 1220 | #witch flounder
         SVSPP == 108 & NESPP4 == 1250 | #windowpane
         SVSPP == 106 & NESPP4 == 1200 | #winter flounder
         SVSPP == 155 & NESPP4 == 2400 | #acadian redfish
         SVSPP == 197 & NESPP4 == 124    #monkfish
        ) %>%
  drop_na(ob_species_cpua, nefsc_species_cpua) %>%
  filter(CATCHWT_updated > 0) %>%
  mutate(relative_efficiency = log(ob_species_cpua)/log(nefsc_species_cpua)) %>%
  mutate(mgmt_area = case_when(
    AREA.x %in% c(511, 512, 513, 514, 515) ~ "GOM", 
    AREA.x %in% c(521, 522, 526, 525, 561, 562, 551, 552) ~ "GB", 
    AREA.x %in% c(611, 612, 613, 539, 538, 537) ~ "SNE"
  )) %>%
  mutate(season = case_when(
    month(START_TOW_DATE_GMT) %in% c(03, 04, 05) ~ "Spring", 
    month(START_TOW_DATE_GMT) %in% c(09, 10, 11) ~ "Fall", 
  )) %>%
  distinct()



```


## 5m and 72hr Paired Tows
```{r}
paired_tows_5mi_72hr_ob_re <- paired_tows_5mi_72hr_ob %>%
  filter(SVSPP == 73 & NESPP4 == 818 | #cod 
         SVSPP == 74 & NESPP4 == 1477 | #haddock
         SVSPP == 75 & NESPP4 == 2695 | #pollock
         SVSPP == 105 & NESPP4 == 1230 | #yellowtail flounder
         SVSPP == 102 & NESPP4 == 1240 | #american plaice
         SVSPP == 107 & NESPP4 == 1220 | #witch flounder
         SVSPP == 108 & NESPP4 == 1250 | #windowpane
         SVSPP == 106 & NESPP4 == 1200 | #winter flounder
         SVSPP == 155 & NESPP4 == 2400 | #acadian redfish
         SVSPP == 197 & NESPP4 == 124    #monkfish
        ) %>%
  drop_na(ob_species_cpua, nefsc_species_cpua) %>%
  filter(CATCHWT_updated > 0) %>%
  mutate(old_relative_efficiency = log(ob_species_cpua)/log(nefsc_species_cpua)) %>%
  mutate(relative_efficiency = nefsc_species_cpua/(nefsc_species_cpua + ob_species_cpua)) %>%
  mutate(mgmt_area = case_when(
    AREA.x %in% c(511, 512, 513, 514, 515) ~ "GOM", 
    AREA.x %in% c(521, 522, 526, 525, 561, 562, 551, 552) ~ "GB", 
    AREA.x %in% c(611, 612, 613, 539, 538, 537) ~ "SNE"
  )) %>%
  mutate(season = case_when(
    month(START_TOW_DATE_GMT) %in% c(03, 04, 05) ~ "Spring", 
    month(START_TOW_DATE_GMT) %in% c(09, 10, 11) ~ "Fall", 
  )) %>%
  mutate(DayNight = case_when(
    dayNight_ob == "night" & dayNight_nefsc == "night" ~ "Night",
    dayNight_ob == "day" & dayNight_nefsc == "day" ~ "Day",
    dayNight_ob == "night" & dayNight_nefsc =="day" ~ "Mismatch",
    dayNight_ob == "day" & dayNight_nefsc == "night" ~ "Mismatch"
  )) %>%
  mutate(towTime = case_when(
    time_dif > 0 ~ "nefsc_first", 
    time_dif < 0 ~ "sf_first"
  )) %>%
  mutate(trawl_type = as.factor(trawl_type)) %>%
  drop_na(trawl_type) %>%
  drop_na(AVGDEPTH, BOTTEMP, DayNight, towTime) %>%
  distinct()

```





# Statistical Analysis
## Species Datasets
```{r}
#creating a separate dataset for each species 
#COD
cod_paired_tows_5mi_72hr_ob_re <- paired_tows_5mi_72hr_ob_re %>%
  filter(SVSPP == 73 & NESPP4 == 818) %>% 
  distinct(trip_haul_ID, .keep_all = TRUE)

#HADDOCK
haddock_paired_tows_5mi_72hr_ob_re <- paired_tows_5mi_72hr_ob_re %>%
  filter(SVSPP == 74 & NESPP4 == 1477) %>% 
  distinct(trip_haul_ID, .keep_all = TRUE)

#WITCH FLOUNDER
witchfl_paired_tows_5mi_72hr_ob_re <- paired_tows_5mi_72hr_ob_re %>%
  filter(SVSPP == 107 & NESPP4 == 1220) %>% 
  distinct(trip_haul_ID, .keep_all = TRUE)

#YELLLOWTAIL FLOUNDER
yellowtailfl_paired_tows_5mi_72hr_ob_re <- paired_tows_5mi_72hr_ob_re %>%
  filter(SVSPP == 105 & NESPP4 == 1230) %>% 
  distinct(trip_haul_ID, .keep_all = TRUE)

#AMERICAN PLAICE
plaice_paired_tows_5mi_72hr_ob_re <- paired_tows_5mi_72hr_ob_re %>%
  filter(SVSPP == 102 & NESPP4 == 1240) %>%
  distinct(trip_haul_ID, .keep_all = TRUE)

#WINTER FLOUNDER
winterfl_paired_tows_5mi_72hr_ob_re <- paired_tows_5mi_72hr_ob_re %>%
  filter(SVSPP == 106 & NESPP4 == 1200) %>%
  distinct(trip_haul_ID, .keep_all = TRUE)

#MONKFISH
monkfish_paired_tows_5mi_72hr_ob_re <- paired_tows_5mi_72hr_ob_re %>%
  filter(SVSPP == 197 & NESPP4 == 124) %>%
  distinct(trip_haul_ID, .keep_all = TRUE)
```


## Function Creation 
```{r}
#################### FUNCTIONS FOR T-TESTS ####################################
#################### FUNCTIONS FOR T-TESTS ####################################
#boxplot for the difference in CPUA
box.plot_diff <- function(x) {
  x %>% 
  ggplot() + 
  geom_boxplot(aes(y = diff)) + 
  labs(y = bquote("Difference between Observer and NEFSC CPUA [lb/"*km^2*"]")) + 
  theme_classic()
}

#boxplot for the difference of the log(CPUA)
box.plot_diff_log <- function(x) {
  x %>% 
  ggplot() + 
  geom_boxplot(aes(y = diff_of_logs)) + 
  labs(y = bquote("Ln(Difference between Observer and NEFSC CPUA [lb/"*km^2*"])")) + 
  theme_classic()
}

#histogram of the difference in CPUA
hist_kh_diff <- function(x) {
  x %>%  
  ggplot() + 
  geom_histogram(aes(x = diff)) + 
  labs(x = bquote("Difference between Observer and NEFSC CPUA [lb/"*km^2*"]"), 
       y = "Count") + 
  theme_classic()
}

#histogram of the difference in log(CPUA)
hist_kh_diff_log <- function(x) {
  x %>%  
  ggplot() + 
  geom_histogram(aes(x = diff_of_logs)) + 
  labs(x = bquote("Ln(Difference between Observer and NEFSC CPUA [lb/"*km^2*"])"), 
       y = "Count") + 
  theme_classic()
}


####################### STUFF I DIDNT END UP USING ############################

CPUA_label <- bquote("CPUA [lb/"*km^2*"]")
logCPUA_lable <- bquote("Log(CPUA [lb/"*km^2*"])")

#plots to check for normality before t-tests 
#boxplot of catch per unit area
box.plot <- function(x) {
  x %>%
  pivot_longer(cols = c(ob_species_cpua, nefsc_species_cpua),
               names_to = "Trawl",
               values_to = "CPUA") %>%
  ggplot() +
  geom_boxplot(aes(x = Trawl, y = CPUA)) +
  labs(x = "Trawl Type", y = CPUA_label) +
  scale_x_discrete(labels = c("nefsc_species_cpua" = "NEFSC",
                              "ob_species_cpua" = "Observer")) +
  theme_classic()
}

#histogram of catch per unit area
hist_kh <- function(x) {
  x %>%
  ggplot() +
  geom_histogram(aes(x = ob_species_cpua, y = ..density.., fill = "Observer")) +
  # geom_label(aes(x = Inf, y = Inf, label = "Study Fleet CPUE", vjust =1 , hjust = 1), color = "red") +
  geom_histogram(aes(x = nefsc_species_cpua, y = -..density.., fill = "NEFSC")) +
  # geom_label(aes(x = Inf, y = -Inf, label = "NEFSC CPUE", vjust = -1, hjust = 1), color = "blue") +
  labs(x = CPUA_label, y = "Density",
       # title = "Histogram of CPUE for x",
       # subtitle = "Pairs within 5 mi and 72 hrs"
       ) +
  scale_fill_manual(name = "Dataset",
                    values = c("Observer" = "red", "NEFSC" = "blue"),
                    labels = c("Observer", "NEFSC")) +
  theme_classic()
}

  



######################## FUNCTIONS FOR MODELLING #############################
#trying to  create functions because I will be running the same models for every species dataset 
covars <- c("season", "mgmt_area", "AVGDEPTH", "BOTTEMP", "DayNight", "towTime")
combos <- purrr::map(1:6, ~as.data.frame(t(combn(covars, .x))))

formulae <- combos %>%
  map_dfr(unite, col="formula", sep = " + ") %>%
  mutate(formula = paste0("relative_efficiency ~  trawl_type + ", formula))


#fit models (takes dataset)
fit.models <- function(x) {
  formulae$formula %>% purrr::map( ~glm(.x, family = binomial, data=x))
}


#compare models (takes list of models created by fit.models())
compare.models <- function(x) {
  formulae %>%
  mutate(aic =  purrr::map_dbl(x, AIC)) %>%
  arrange(desc(aic)) %>%
  mutate(deltaAIC = aic - aic[63]) %>%
  mutate(rsq =  purrr::map_dbl(x, Dsquared)) %>% 
  mutate(rsq = sprintf("%0.2f", rsq)) %>%
  mutate(aic = sprintf("%1.0f", aic)) %>%
  mutate(deltaAIC = sprintf("%1.0f", deltaAIC)) %>%
  kbl(col.names = (c("Model", "AIC", "deltaAIC","Deviance Explained"))) %>%
  kable_classic("striped", full_width = FALSE)
}

#predicted v actual plots 
predict.plot <- function(x,y) {
  x %>%
  ggplot() + 
  geom_point(aes(x = relative_efficiency,
                 y = predict(y), shape = trawl_type)) + 
  labs(title = "Predicted v Actual Values", 
       subtitle = "Pairs within 5 mi and 72 hrs",
       x = "Actual Values", y = "Predicted Values") + 
  facet_wrap(~ trawl_type, 
             labeller = as_labeller(c("1" = "Generic Groundfish Trawls", 
                                      "2" = "Flatfish Trawls", 
                                      "3" = "Separator Trawls",
                                      "5" = "Other/Unknown Trawls"))) + 
  guides(shape = FALSE) + 
  theme_classic() 
}


```



# Statisitical Analysis by Species 
## Cod
#### Exploratory Plots 
```{r}
#Looking at the cpua for the paired tows for each species 
cod_paired_tows_5mi_72hr_ob_re %>%
  ggplot() + 
  geom_bar(aes(x = trip_haul_ID, y = ob_species_cpua, fill = "Observer"), stat = "identity") + 
  geom_bar(aes(x = trip_haul_ID, y = -nefsc_species_cpua, fill = "NEFSC"), stat = "identity") + 
  labs(x = "Tow Number", y = CPUA_label, 
       title = "Comparison of CPUA for Atlantic Cod", 
       subtitle = "Pairs within 5 mi and 72 hrs") + 
  scale_fill_manual(name = "", 
                    values = c("Observer" = "red", "NEFSC" = "blue"), 
                    labels = c("Observer", "NEFSC")) + 
  theme_classic() + 
  theme(axis.text.x=element_blank())


#Looking at the relative efficiency of the study fleet tows compared to the nefsc survey 
cod_paired_tows_5mi_72hr_ob_re %>%
  ggplot() +
  geom_histogram(aes(x = relative_efficiency), bins = 100, color = "black", fill = "white") + 
  geom_vline(aes(xintercept = 0.5),
            color = "black", linetype = "dashed", size = 1) + 
  geom_vline(aes(xintercept = mean(relative_efficiency)),
            color = "red", linetype = "dashed", size = 1) + 
  labs(x = "Relative Efficiency", y = "Count", 
       title = "Histogram of Relative Efficiency for Atlantic Cod", 
       subtitle = "Pairs within 5 mi and 72 hrs")  


#Map of the matched tows 
cod_paired_tows_5mi_72hr_ob_re %>%
  ggplot() + 
  geom_sf(data = nefsc_strata, fill = "grey") +
  geom_polygon(data = NEUS, aes(x=long, y = lat, group = group), fill = "darkgreen",  
               color="black",inherit.aes = FALSE)  +
  geom_point(data = cod_paired_tows_5mi_72hr_ob_re, aes(x = END_TOW_LON.x,y = END_TOW_LAT.x, color = "NEFSC")) +
  geom_point(data = cod_paired_tows_5mi_72hr_ob_re, aes(x = END_TOW_LON.y,y = END_TOW_LAT.y, color = "Observer")) +
  
  # geom_segment(data = paired_tows_1mi_24hr, aes(x = START_TOW_LON.x, xend = END_TOW_LON.x,
  #                                               y = START_TOW_LAT.x, yend = END_TOW_LAT.x)) +
  coord_sf(ylim = c(39, 44),  xlim = c(-74, -66)) + 
  scale_colour_manual("", breaks = c("Observer", "NEFSC"), values = c("red", "blue")) +
  labs(title = "Map of Matched Observer and NEFSC Tows for Cod", subtitle = "within 5 mi and 72 hrs")


#looking at scatterplot of CPUAs 
cod_paired_tows_5mi_72hr_ob_re %>%
  ggplot(aes(x = ob_species_cpua, 
             y = nefsc_species_cpua)) + 
  geom_point() + 
  geom_abline(intercept = 0, slope = 1) +
  labs(x = 'Observer CPUA', y = 'NEFSC CPUA', title = '')


```


#### T-test
```{r}
#looking at the boxplot and histograms of the catch per unit area 
box.plot(cod_paired_tows_5mi_72hr_ob_re)
hist_kh(cod_paired_tows_5mi_72hr_ob_re)

#log-transforming the data
cod_paired_tows_5mi_72hr_ob_re <- cod_paired_tows_5mi_72hr_ob_re %>%
  mutate(diff = ob_species_cpua - nefsc_species_cpua,
         log_ob_species_cpua = log(ob_species_cpua), 
         log_nefsc_species_cpua = log(nefsc_species_cpua), 
         diff_of_logs = log_ob_species_cpua - log_nefsc_species_cpua)

#looking at the boxplot and histograms of the difference between CPUA
box.plot_diff(cod_paired_tows_5mi_72hr_ob_re)
hist_kh_diff(cod_paired_tows_5mi_72hr_ob_re)

#looking at the boxplot and histograms of the diff_of_logs
box.plot_diff_log(cod_paired_tows_5mi_72hr_ob_re)
hist_kh_diff_log(cod_paired_tows_5mi_72hr_ob_re)

#assumptions of normality and equal variance are met with the log transformed data, 
#so the t-test was conducted with the log-transformed data
cod_ob_ttest <- t.test(cod_paired_tows_5mi_72hr_ob_re$log_ob_species_cpua, cod_paired_tows_5mi_72hr_ob_re$log_nefsc_species_cpua, paired = TRUE)
cod_ob_ttest


#back transform the estimate
exp(cod_ob_ttest$estimate)
exp(cod_ob_ttest$conf.int)

```

#### Model Run 
```{r, message = FALSE, warning = FALSE}
#COD
codm <- fit.models(cod_paired_tows_5mi_72hr_ob_re)
compare.models(codm)


#storing the optimal model and plotting the diagnostics
codm_ob_optimal <- glm(relative_efficiency ~ trawl_type + AVGDEPTH, family = binomial, data = cod_paired_tows_5mi_72hr_ob_re)

par(mfrow=c(2,2))
plot(codm_ob_optimal)

summary(codm_ob_optimal)

#back transform the estimates into an odds-ratio 
exp(cbind(OR = coef(codm_ob_optimal), confint(codm_ob_optimal)))

#look at the component residual plots 
crPlots(codm_ob_optimal)


# Extract the fitted and predicted values 
cod_paired_tows_5mi_72hr_ob_re$predict <- predict(codm_ob_optimal)
cod_paired_tows_5mi_72hr_ob_re$fitted <- fitted(codm_ob_optimal)

#predicted vs observed values 
cod_paired_tows_5mi_72hr_ob_re %>%
  ggplot(aes(x = fitted, 
             y = relative_efficiency)) + 
  geom_point() + 
  geom_abline(intercept=0, slope=1) +
  xlim(0,1) + 
  ylim(0,1) + 
  labs(x='Predicted Values', y='Actual Values', title='Predicted vs. Actual Values')



#getting final RE estimate 
cod_paired_tows_5mi_72hr_ob_re %>%
  group_by(trawl_type) %>%
  summarise(mean(fitted), n = n())

cod_paired_tows_5mi_72hr_ob_re %>%
  summarise(mean(fitted), n = n())

#plot of trawl type and relative efficiency estimates from the model and the mean for each trawl type 
cod_paired_tows_5mi_72hr_ob_re %>%
  ggplot(aes(x = trawl_type, 
             y = fitted)) + 
  geom_jitter() + 
  stat_summary(
    geom = "point",
    fun = "mean",
    col = "black",
    size = 3,
    shape = 24,
    fill = "red"
  ) + 
  labs(x = "Trawl Type", y = "Fitted Values of Relative Efficiency") + 
  geom_hline(yintercept = 0.6005787, linetype = "dashed", color = "red") + 
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "black") + 
  scale_x_discrete(labels=c("1" = "Groundfish Trawls", "2" = "Flatfish Trawls",
                              "3" = "Separator Trawls", "4" = "Eliminator Trawls")) + 
  coord_flip()


cod_paired_tows_5mi_72hr_ob_re %>%
  ggplot(aes(x = AVGDEPTH, y = relative_efficiency, color = trawl_type, pch = trawl_type)) + 
  geom_point() + 
  geom_smooth(method = 'glm', method.args = list(family = 'binomial')) + 
  labs(x = "Average Depth", y = "Relative Efficiency") + 
  theme_classic()


#plotting effects of each variable on RE
plot(allEffects(codm_ob_optimal))


###############################################################################
# #predicted vs trawl type w point shape as explanatory variables - not important for this project but saving for my thesis work 
#mgmt_area
cod_paired_tows_5mi_72hr_ob_re %>%
  ggplot(aes(x = trawl_type,
             y = fitted, color = mgmt_area)) +
  geom_jitter() +
  labs(x = "Vessel Name", y = "Fitted Values") +
  coord_flip()

#season
cod_paired_tows_5mi_72hr_ob_re %>%
  ggplot(aes(x = trawl_type,
             y = fitted, color = season)) +
  geom_jitter() +
  coord_flip()

#depth
cod_paired_tows_5mi_72hr_ob_re %>%
  ggplot(aes(x = trawl_type,
             y = fitted, color = BOTTEMP)) +
  geom_jitter() +
  coord_flip()

#foot rope length 
cod_paired_tows_5mi_72hr_ob_re %>%
  ggplot(aes(x = trawl_type,
             y = fitted, color = FTROPLEN)) +
  geom_jitter() +
  coord_flip()


#sweep diameter
cod_paired_tows_5mi_72hr_ob_re %>%
  ggplot(aes(x = trawl_type,
             y = fitted, color = SWEEPDIA)) +
  geom_jitter() +
  coord_flip()


#n sweeps
cod_paired_tows_5mi_72hr_ob_re %>%
  ggplot(aes(x = trawl_type,
             y = fitted, color = NSWEEPS)) +
  geom_jitter() +
  coord_flip()


#footrope type
cod_paired_tows_5mi_72hr_ob_re %>%
  ggplot(aes(x = trawl_type,
             y = fitted, color = as.factor(FTROPTYP))) +
  geom_jitter() +
  coord_flip()

#ground cable type
cod_paired_tows_5mi_72hr_ob_re %>%
  ggplot(aes(x = trawl_type,
             y = fitted, color = as.factor(GRCABTYP))) +
  geom_jitter() +
  coord_flip()






```

## Haddock
#### Exploratory Plots 
```{r}
#Looking at the cpua for the paired tows for each species 
haddock_paired_tows_5mi_72hr_ob_re %>%
  ggplot() + 
  geom_bar(aes(x = trip_haul_ID, y = ob_species_cpua, fill = "Observer"), stat = "identity") + 
  geom_bar(aes(x = trip_haul_ID, y = -nefsc_species_cpua, fill = "NEFSC"), stat = "identity") + 
  labs(x = "Tow Number", y = CPUA_label, 
       title = "Comparison of CPUA for Haddock", 
       subtitle = "Pairs within 5 mi and 72 hrs") + 
  scale_fill_manual(name = "", 
                    values = c("Observer" = "red", "NEFSC" = "blue"), 
                    labels = c("Observer", "NEFSC")) + 
  theme_classic() + 
  theme(axis.text.x=element_blank())

#Looking at the relative efficiency of the study fleet tows compared to the nefsc survey 
haddock_paired_tows_5mi_72hr_ob_re %>%
  ggplot() +
  geom_histogram(aes(x = relative_efficiency), bins = 100, color = "black", fill = "white") + 
  geom_vline(aes(xintercept = 0.5),
            color = "black", linetype = "dashed", size = 1) + 
  geom_vline(aes(xintercept = mean(relative_efficiency)),
            color = "red", linetype = "dashed", size = 1) + 
  labs(x = "Relative Efficiency", y = "Count", 
       title = "Histogram of Relative Efficiency for Haddock", 
       subtitle = "Pairs within 5 mi and 72 hrs")


# Looks like there are some unrealistic outliers from the science center trawl 
haddock_paired_tows_5mi_72hr_ob_re <- haddock_paired_tows_5mi_72hr_ob_re %>%
  filter(ob_species_cpua < 10000) %>%
  filter(nefsc_species_cpua < 10000)
  
  
#Looking at the cpua for the paired tows for each species with outliers removed 
haddock_paired_tows_5mi_72hr_ob_re %>%
  ggplot() + 
  geom_bar(aes(x = trip_haul_ID, y = ob_species_cpua, fill = "Observer"), stat = "identity") + 
  geom_bar(aes(x = trip_haul_ID, y = -nefsc_species_cpua, fill = "NEFSC"), stat = "identity") + 
  labs(x = "Tow Number", y = CPUA_label, 
       title = "Comparison of CPUA for Haddock", 
       subtitle = "Pairs within 5 mi and 72 hrs") + 
  scale_fill_manual(name = "", 
                    values = c("Observer" = "red", "NEFSC" = "blue"), 
                    labels = c("Observer", "NEFSC")) + 
  theme_classic() + 
  theme(axis.text.x=element_blank())

#Looking at the relative efficiency of the study fleet tows compared to the nefsc survey 
haddock_paired_tows_5mi_72hr_ob_re %>%
  ggplot() +
  geom_histogram(aes(x = relative_efficiency), bins = 100, color = "black", fill = "white") + 
  geom_vline(aes(xintercept = 0.5),
            color = "black", linetype = "dashed", size = 1) + 
  geom_vline(aes(xintercept = mean(relative_efficiency)),
            color = "red", linetype = "dashed", size = 1) + 
  labs(x = "Relative Efficiency", y = "Count", 
       title = "Histogram of Relative Efficiency for Haddock", 
       subtitle = "Pairs within 5 mi and 72 hrs")
  

#Map of the matched tows 
haddock_paired_tows_5mi_72hr_ob_re %>%
  ggplot() + 
  geom_sf(data = nefsc_strata, fill = "grey") +
  geom_polygon(data = NEUS, aes(x=long, y = lat, group = group), fill = "darkgreen",  
               color="black",inherit.aes = FALSE)  +
  geom_point(data = haddock_paired_tows_5mi_72hr_ob_re, aes(x = END_TOW_LON.x,y = END_TOW_LAT.x, color = "NEFSC")) +
  geom_point(data = haddock_paired_tows_5mi_72hr_ob_re, aes(x = END_TOW_LON.y,y = END_TOW_LAT.y, color = "Observer")) +
  
  # geom_segment(data = paired_tows_1mi_24hr, aes(x = START_TOW_LON.x, xend = END_TOW_LON.x,
  #                                               y = START_TOW_LAT.x, yend = END_TOW_LAT.x)) +
  coord_sf(ylim = c(39, 44),  xlim = c(-74, -66)) + 
  scale_colour_manual("", breaks = c("Observer", "NEFSC"), values = c("red", "blue")) +
  labs(title = "Map of Matched Observer and NEFSC Tows for Haddock", subtitle = "within 5 mi and 72 hrs")



#looking at scatterplot of CPUAs 
haddock_paired_tows_5mi_72hr_ob_re %>%
  ggplot(aes(x = ob_species_cpua, 
             y = nefsc_species_cpua)) + 
  geom_point() + 
  geom_abline(intercept = 0, slope = 1) +
  labs(x = 'Observer CPUA', y = 'NEFSC CPUA', title = '')

```


#### T-test
```{r}
#looking at the boxplot and histograms of the catch per unit area 
box.plot(haddock_paired_tows_5mi_72hr_ob_re)
hist_kh(haddock_paired_tows_5mi_72hr_ob_re)

#log-transforming the data
haddock_paired_tows_5mi_72hr_ob_re <- haddock_paired_tows_5mi_72hr_ob_re %>%
  mutate(diff = ob_species_cpua - nefsc_species_cpua,
         log_ob_species_cpua = log(ob_species_cpua), 
         log_nefsc_species_cpua = log(nefsc_species_cpua), 
         diff_of_logs = log_ob_species_cpua - log_nefsc_species_cpua)

#looking at the boxplot and histograms of the difference between CPUA
box.plot_diff(haddock_paired_tows_5mi_72hr_ob_re)
hist_kh_diff(haddock_paired_tows_5mi_72hr_ob_re)

#looking at the boxplot and histograms of the diff_of_logs
box.plot_diff_log(haddock_paired_tows_5mi_72hr_ob_re)
hist_kh_diff_log(haddock_paired_tows_5mi_72hr_ob_re)

#assumptions of normality and equal variance are met with the log transformed data, 
#so the t-test was conducted with the log-transformed data

haddock_ob_ttest <- t.test(haddock_paired_tows_5mi_72hr_ob_re$log_ob_species_cpua, haddock_paired_tows_5mi_72hr_ob_re$log_nefsc_species_cpua, paired = TRUE)
haddock_ob_ttest


#back transform the estimate
exp(haddock_ob_ttest$estimate)
exp(haddock_ob_ttest$conf.int)

```

#### Model Run 
```{r, message = FALSE, warning = FALSE}
#HADDOCK
haddockm <- fit.models(haddock_paired_tows_5mi_72hr_ob_re)
compare.models(haddockm)


#storing the optimal model and plotting the diagnostics
haddockm_ob_optimal <- glm(relative_efficiency ~  trawl_type + season + mgmt_area + AVGDEPTH + towTime, 
                           family = binomial, data = haddock_paired_tows_5mi_72hr_ob_re)

par(mfrow=c(2,2))
plot(haddockm_ob_optimal)

summary(haddockm_ob_optimal)

#back transform the estimates into an odds-ratio 
exp(cbind(OR = coef(haddockm_ob_optimal), confint(haddockm_ob_optimal)))

#look at the component residual plots 
crPlots(haddockm_ob_optimal)


# Extract the fitted and predicted values 
haddock_paired_tows_5mi_72hr_ob_re$predict <- predict(haddockm_ob_optimal)
haddock_paired_tows_5mi_72hr_ob_re$fitted <- fitted(haddockm_ob_optimal)

#predicted vs observed values 
haddock_paired_tows_5mi_72hr_ob_re %>%
  ggplot(aes(x = fitted, 
             y = relative_efficiency)) + 
  geom_point() + 
  geom_abline(intercept=0, slope=1) +
  xlim(0,1) + 
  ylim(0,1) + 
  labs(x='Predicted Values', y='Actual Values', title='Predicted vs. Actual Values')



#getting final RE estimate 
haddock_paired_tows_5mi_72hr_ob_re %>%
  group_by(trawl_type) %>%
  summarise(mean(fitted), n = n())

haddock_paired_tows_5mi_72hr_ob_re %>%
  summarise(mean(fitted), n = n())

#plot of trawl type and relative efficiency estimates from the model and the mean for each trawl type 
haddock_paired_tows_5mi_72hr_ob_re %>%
  ggplot(aes(x = trawl_type, 
             y = fitted)) + 
  geom_jitter() + 
  stat_summary(
    geom = "point",
    fun = "mean",
    col = "black",
    size = 3,
    shape = 24,
    fill = "red"
  ) + 
  labs(x = "Trawl Type", y = "Fitted Values of Relative Efficiency") + 
  geom_hline(yintercept = 0.6276351, linetype = "dashed", color = "red") + 
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "black") + 
  scale_x_discrete(labels=c("1" = "Groundfish Trawls", "2" = "Flatfish Trawls",
                              "3" = "Separator Trawls", "4" = "Eliminator Trawls")) + 
  coord_flip()


#plotting effects of each variable on RE
plot(allEffects(haddockm_ob_optimal))


```

## Witch Flounder
#### Exploratory Plots
```{r}
#Looking at the cpua for the paired tows for each species 
witchfl_paired_tows_5mi_72hr_ob_re %>%
  ggplot() + 
  geom_bar(aes(x = trip_haul_ID, y = ob_species_cpua, fill = "Observer"), stat = "identity") + 
  geom_bar(aes(x = trip_haul_ID, y = -nefsc_species_cpua,  fill = "NEFSC"), stat = "identity") + 
  labs(x = "Tow Number", y = CPUA_label, 
       title = "Comparison of CPUA for Witch Flounder", 
       subtitle = "Pairs within 5 mi and 72 hrs") + 
  scale_fill_manual(name = "",
                    values = c("Observer" = "red", "NEFSC" = "blue"), 
                    labels = c("Observer", "NEFSC")) + 
  theme_classic() + 
  theme(axis.text.x=element_blank())


#Looking at the relative efficiency of the study fleet tows compared to the nefsc survey 
witchfl_paired_tows_5mi_72hr_ob_re %>%
  ggplot() +
  geom_histogram(aes(x = relative_efficiency), bins = 100, color = "black", fill = "white") + 
  geom_vline(aes(xintercept = 0.5),
            color = "black", linetype = "dashed", size = 1) + 
  geom_vline(aes(xintercept = mean(relative_efficiency)),
            color = "red", linetype = "dashed", size = 1) + 
  labs(x = "Relative Efficiency", y = "Count", 
       title = "Histogram of Relative Efficiency for Witch Flounder", 
       subtitle = "Pairs within 5 mi and 72 hrs")


#Map of the matched tows 
witchfl_paired_tows_5mi_72hr_ob_re %>%
  ggplot() + 
  geom_sf(data = nefsc_strata, fill = "grey") +
  geom_polygon(data = NEUS, aes(x=long, y = lat, group = group), fill = "darkgreen",  
               color="black",inherit.aes = FALSE)  +
  geom_point(data = witchfl_paired_tows_5mi_72hr_ob_re, aes(x = END_TOW_LON.x,y = END_TOW_LAT.x, color = "NEFSC")) +
  geom_point(data = witchfl_paired_tows_5mi_72hr_ob_re, aes(x = END_TOW_LON.y,y = END_TOW_LAT.y, color = "Observer")) +
  
  # geom_segment(data = paired_tows_1mi_24hr, aes(x = START_TOW_LON.x, xend = END_TOW_LON.x,
  #                                               y = START_TOW_LAT.x, yend = END_TOW_LAT.x)) +
  coord_sf(ylim = c(39, 44),  xlim = c(-74, -66)) + 
  scale_colour_manual("", breaks = c("Observer", "NEFSC"), values = c("red", "blue")) +
  labs(title = "Map of Matched Observer and NEFSC Tows for Witch Flounder", subtitle = "within 5 mi and 72 hrs")


#looking at scatterplot of CPUAs 
witchfl_paired_tows_5mi_72hr_ob_re %>%
  ggplot(aes(x = ob_species_cpua, 
             y = nefsc_species_cpua)) + 
  geom_point() + 
  geom_abline(intercept = 0, slope = 1) +
  labs(x = 'Observer CPUA', y = 'NEFSC CPUA', title = '')

```


#### T-test
```{r}
#looking at the boxplot and histograms of the catch per unit area 
box.plot(witchfl_paired_tows_5mi_72hr_ob_re)
hist_kh(witchfl_paired_tows_5mi_72hr_ob_re)

#log-transforming the data
witchfl_paired_tows_5mi_72hr_ob_re <- witchfl_paired_tows_5mi_72hr_ob_re %>%
  mutate(diff = ob_species_cpua - nefsc_species_cpua,
         log_ob_species_cpua = log(ob_species_cpua), 
         log_nefsc_species_cpua = log(nefsc_species_cpua), 
         diff_of_logs = log_ob_species_cpua - log_nefsc_species_cpua)

#looking at the boxplot and histograms of the difference between CPUA
box.plot_diff(witchfl_paired_tows_5mi_72hr_ob_re)
hist_kh_diff(witchfl_paired_tows_5mi_72hr_ob_re)

#looking at the boxplot and histograms of the diff_of_logs
box.plot_diff_log(witchfl_paired_tows_5mi_72hr_ob_re)
hist_kh_diff_log(witchfl_paired_tows_5mi_72hr_ob_re)

#assumptions of normality and equal variance are met with the log transformed data, 
#so the t-test was conducted with the log-transformed data

witchfl_ob_ttest <- t.test(witchfl_paired_tows_5mi_72hr_ob_re$log_ob_species_cpua, witchfl_paired_tows_5mi_72hr_ob_re$log_nefsc_species_cpua, paired = TRUE)
witchfl_ob_ttest

#back transform the estimate
exp(witchfl_ob_ttest$estimate)
exp(witchfl_ob_ttest$conf.int)

```

#### Model Run 
```{r, message = FALSE, warning = FALSE}
#WITCH FLOUNDER 
witchflm <- fit.models(witchfl_paired_tows_5mi_72hr_ob_re)
compare.models(witchflm)


#storing the optimal model and plotting the diagnostics
witchflm_ob_optimal <- glm(relative_efficiency ~ trawl_type + season, 
                           family = binomial, data = witchfl_paired_tows_5mi_72hr_ob_re)

par(mfrow=c(2,2))
plot(witchflm_ob_optimal)

summary(witchflm_ob_optimal)

#back transform the estimates into an odds-ratio 
exp(cbind(OR = coef(witchflm_ob_optimal), confint(witchflm_ob_optimal)))

#look at the component residual plots 
crPlots(witchflm_ob_optimal)


# Extract the fitted and predicted values 
witchfl_paired_tows_5mi_72hr_ob_re$predict <- predict(witchflm_ob_optimal)
witchfl_paired_tows_5mi_72hr_ob_re$fitted <- fitted(witchflm_ob_optimal)

#predicted vs observed values 
witchfl_paired_tows_5mi_72hr_ob_re %>%
  ggplot(aes(x = fitted, 
             y = relative_efficiency)) + 
  geom_point() + 
  geom_abline(intercept=0, slope=1) +
  xlim(0,1) + 
  ylim(0,1) + 
  labs(x='Predicted Values', y='Actual Values', title='Predicted vs. Actual Values')



#getting final RE estimate 
witchfl_paired_tows_5mi_72hr_ob_re %>%
  group_by(trawl_type) %>%
  summarise(mean(fitted), n = n())

witchfl_paired_tows_5mi_72hr_ob_re %>%
  summarise(mean(fitted), n = n())

#plot of trawl type and relative efficiency estimates from the model and the mean for each trawl type 
witchfl_paired_tows_5mi_72hr_ob_re %>%
  ggplot(aes(x = trawl_type, 
             y = fitted)) + 
  geom_jitter() + 
  stat_summary(
    geom = "point",
    fun = "mean",
    col = "black",
    size = 3,
    shape = 24,
    fill = "red"
  ) + 
  labs(x = "Trawl Type", y = "Fitted Values of Relative Efficiency") + 
  geom_hline(yintercept = 0.4874408, linetype = "dashed", color = "red") + 
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "black") + 
  scale_x_discrete(labels=c("1" = "Groundfish Trawls", "2" = "Flatfish Trawls",
                              "3" = "Separator Trawls", "4" = "Eliminator Trawls")) + 
  coord_flip()

#plotting effects of each variable on RE
plot(allEffects(witchflm_ob_optimal))


```

## Yewllowtail Flounder
#### Exploratory Plots 
```{r}
#Looking at the cpua for the paired tows for each species 
yellowtailfl_paired_tows_5mi_72hr_ob_re %>%
  ggplot() + 
  geom_bar(aes(x = trip_haul_ID, y = ob_species_cpua, fill = "Observer"), stat = "identity") + 
  geom_bar(aes(x = trip_haul_ID, y = -nefsc_species_cpua, fill = "NEFSC"), stat = "identity") + 
  labs(x = "Tow Number", y = CPUA_label, 
       title = "Comparison of CPUA for Yellowtail Flounder", 
       subtitle = "Pairs within 5 mi and 72 hrs") + 
  scale_fill_manual(name = "",
                    values = c("Observer" = "red", "NEFSC" = "blue"), 
                    labels = c("Observer", "NEFSC")) + 
  theme_classic() + 
  theme(axis.text.x=element_blank())

#Looking at the relative efficiency of the study fleet tows compared to the nefsc survey 
yellowtailfl_paired_tows_5mi_72hr_ob_re %>%
  ggplot() +
  geom_histogram(aes(x = relative_efficiency), bins = 100, color = "black", fill = "white") + 
  geom_vline(aes(xintercept = 0.5),
            color = "black", linetype = "dashed", size = 1) + 
  geom_vline(aes(xintercept = mean(relative_efficiency)),
            color = "red", linetype = "dashed", size = 1) + 
  labs(x = "Relative Efficiency", y = "Count", 
       title = "Histogram of Relative Efficiency for Yellowtail Flounder", 
       subtitle = "Pairs within 5 mi and 72 hrs")
  

#Map of the matched tows 
yellowtailfl_paired_tows_5mi_72hr_ob_re %>%
  ggplot() + 
  geom_sf(data = nefsc_strata, fill = "grey") +
  geom_polygon(data = NEUS, aes(x=long, y = lat, group = group), fill = "darkgreen",  
               color="black",inherit.aes = FALSE)  +
  geom_point(data = yellowtailfl_paired_tows_5mi_72hr_ob_re, aes(x = END_TOW_LON.x,y = END_TOW_LAT.x, color = "NEFSC")) +
  geom_point(data = yellowtailfl_paired_tows_5mi_72hr_ob_re, aes(x = END_TOW_LON.y,y = END_TOW_LAT.y, color = "Observer")) +
  
  # geom_segment(data = paired_tows_1mi_24hr, aes(x = START_TOW_LON.x, xend = END_TOW_LON.x,
  #                                               y = START_TOW_LAT.x, yend = END_TOW_LAT.x)) +
  coord_sf(ylim = c(39, 44),  xlim = c(-74, -66)) + 
  scale_colour_manual("", breaks = c("Observer", "NEFSC"), values = c("red", "blue")) +
  labs(title = "Map of Matched Observer and NEFSC Tows for Yellowtail Flounder", subtitle = "within 5 mi and 72 hrs")


#looking at scatterplot of CPUAs 
yellowtailfl_paired_tows_5mi_72hr_ob_re %>%
  ggplot(aes(x = ob_species_cpua, 
             y = nefsc_species_cpua)) + 
  geom_point() + 
  geom_abline(intercept = 0, slope = 1) +
  labs(x = 'Observer CPUA', y = 'NEFSC CPUA', title = '')

```


#### T-test
```{r}
#looking at the boxplot and histograms of the catch per unit area 
box.plot(yellowtailfl_paired_tows_5mi_72hr_ob_re)
hist_kh(yellowtailfl_paired_tows_5mi_72hr_ob_re)

#log-transforming the data
yellowtailfl_paired_tows_5mi_72hr_ob_re <- yellowtailfl_paired_tows_5mi_72hr_ob_re %>%
  mutate(diff = ob_species_cpua - nefsc_species_cpua,
         log_ob_species_cpua = log(ob_species_cpua), 
         log_nefsc_species_cpua = log(nefsc_species_cpua), 
         diff_of_logs = log_ob_species_cpua - log_nefsc_species_cpua)

#looking at the boxplot and histograms of the difference between CPUA
box.plot_diff(yellowtailfl_paired_tows_5mi_72hr_ob_re)
hist_kh_diff(yellowtailfl_paired_tows_5mi_72hr_ob_re)

#looking at the boxplot and histograms of the diff_of_logs
box.plot_diff_log(yellowtailfl_paired_tows_5mi_72hr_ob_re)
hist_kh_diff_log(yellowtailfl_paired_tows_5mi_72hr_ob_re)

#assumptions of normality and equal variance are met with the log transformed data, 
#so the t-test was conducted with the log-transformed data

yellowtail_ob_ttest <- t.test(yellowtailfl_paired_tows_5mi_72hr_ob_re$log_ob_species_cpua,
                              yellowtailfl_paired_tows_5mi_72hr_ob_re$log_nefsc_species_cpua, 
                              paired = TRUE)
yellowtail_ob_ttest


#back transform the estimate
exp(yellowtail_ob_ttest$estimate)
exp(yellowtail_ob_ttest$conf.int)

```

#### Model Run 
```{r, message = FALSE, warning = FALSE}
#YELLOWTAIL FLOUNDER
yellowtailflm <- fit.models(yellowtailfl_paired_tows_5mi_72hr_ob_re)
compare.models(yellowtailflm)


#storing the optimal model and plotting the diagnostics
yellowtailflm_ob_optimal <- glm(relative_efficiency ~ trawl_type + season, family = binomial, data = yellowtailfl_paired_tows_5mi_72hr_ob_re)

par(mfrow=c(2,2))
plot(yellowtailflm_ob_optimal)

summary(yellowtailflm_ob_optimal)

#back transform the estimates into an odds-ratio 
exp(cbind(OR = coef(yellowtailflm_ob_optimal), confint(yellowtailflm_ob_optimal)))

#look at the component residual plots 
crPlots(yellowtailflm_ob_optimal)


# Extract the fitted and predicted values 
yellowtailfl_paired_tows_5mi_72hr_ob_re$predict <- predict(yellowtailflm_ob_optimal)
yellowtailfl_paired_tows_5mi_72hr_ob_re$fitted <- fitted(yellowtailflm_ob_optimal)

#predicted vs observed values 
yellowtailfl_paired_tows_5mi_72hr_ob_re %>%
  ggplot(aes(x = fitted, 
             y = relative_efficiency)) + 
  geom_point() + 
  geom_abline(intercept=0, slope=1) +
  xlim(0,1) + 
  ylim(0,1) + 
  labs(x='Predicted Values', y='Actual Values', title='Predicted vs. Actual Values')



#getting final RE estimate 
yellowtailfl_paired_tows_5mi_72hr_ob_re %>%
  group_by(trawl_type) %>%
  summarise(mean(fitted), n = n())

yellowtailfl_paired_tows_5mi_72hr_ob_re %>%
  summarise(mean(fitted), n = n())

#plot of trawl type and relative efficiency estimates from the model and the mean for each trawl type 
yellowtailfl_paired_tows_5mi_72hr_ob_re %>%
  ggplot(aes(x = trawl_type, 
             y = fitted)) + 
  geom_jitter() + 
  stat_summary(
    geom = "point",
    fun = "mean",
    col = "black",
    size = 3,
    shape = 24,
    fill = "red"
  ) + 
  labs(x = "Trawl Type", y = "Fitted Values of Relative Efficiency") + 
  geom_hline(yintercept = 0.6146174, linetype = "dashed", color = "red") + 
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "black") + 
  scale_x_discrete(labels=c("1" = "Groundfish Trawls", "2" = "Flatfish Trawls",
                              "3" = "Separator Trawls", "4" = "Eliminator Trawls")) + 
  coord_flip()


#plotting effects of each variable on RE
plot(allEffects(yellowtailflm_ob_optimal))

```

## American Plaice
#### Exploratory PLots 
```{r}
#Looking at the cpua for the paired tows for each species 
plaice_paired_tows_5mi_72hr_ob_re %>%
  ggplot() + 
  geom_bar(aes(x = trip_haul_ID, y = ob_species_cpua, fill = "Observer"), stat = "identity") + 
  geom_bar(aes(x = trip_haul_ID, y = -nefsc_species_cpua,  fill = "NEFSC"), stat = "identity") + 
  labs(x = "Tow Number", y = CPUA_label, 
       title = "Comparison of CPUA for American Plaice", 
       subtitle = "Pairs within 5 mi and 72 hrs") + 
  scale_fill_manual(name = "",
                    values = c("Observer" = "red", "NEFSC" = "blue"), 
                    labels = c("Observer", "NEFSC")) + 
  theme_classic() + 
  theme(axis.text.x=element_blank())

#Looking at the relative efficiency of the study fleet tows compared to the nefsc survey 
plaice_paired_tows_5mi_72hr_ob_re %>%
  ggplot() +
  geom_histogram(aes(x = relative_efficiency), bins = 100, color = "black", fill = "white") + 
  geom_vline(aes(xintercept = 0.5),
            color = "black", linetype = "dashed", size = 1) + 
  geom_vline(aes(xintercept = mean(relative_efficiency)),
            color = "red", linetype = "dashed", size = 1) + 
  labs(x = "Relative Efficiency", y = "Count", 
       title = "Histogram of Relative Efficiency for American Plaice", 
       subtitle = "Pairs within 5 mi and 72 hrs")


#Map of the matched tows 
plaice_paired_tows_5mi_72hr_ob_re %>%
  ggplot() + 
  geom_sf(data = nefsc_strata, fill = "grey") +
  geom_polygon(data = NEUS, aes(x=long, y = lat, group = group), fill = "darkgreen",  
               color="black",inherit.aes = FALSE)  +
  geom_point(data = plaice_paired_tows_5mi_72hr_ob_re, aes(x = END_TOW_LON.x,y = END_TOW_LAT.x, color = "NEFSC")) +
  geom_point(data = plaice_paired_tows_5mi_72hr_ob_re, aes(x = END_TOW_LON.y,y = END_TOW_LAT.y, color = "Observer")) +
  
  # geom_segment(data = paired_tows_1mi_24hr, aes(x = START_TOW_LON.x, xend = END_TOW_LON.x,
  #                                               y = START_TOW_LAT.x, yend = END_TOW_LAT.x)) +
  coord_sf(ylim = c(39, 44),  xlim = c(-74, -66)) + 
  scale_colour_manual("", breaks = c("Observer", "NEFSC"), values = c("red", "blue")) +
  labs(title = "Map of Matched Observer and NEFSC Tows for American Plaice", subtitle = "within 5 mi and 72 hrs")


#looking at scatterplot of CPUAs 
plaice_paired_tows_5mi_72hr_ob_re %>%
  ggplot(aes(x = ob_species_cpua, 
             y = nefsc_species_cpua)) + 
  geom_point() + 
  geom_abline(intercept = 0, slope = 1) +
  labs(x = 'Observer CPUA', y = 'NEFSC CPUA', title = '')

```


#### T-test
```{r}
#looking at the boxplot and histograms of the catch per unit area 
box.plot(plaice_paired_tows_5mi_72hr_ob_re)
hist_kh(plaice_paired_tows_5mi_72hr_ob_re)

#log-transforming the data
plaice_paired_tows_5mi_72hr_ob_re <- plaice_paired_tows_5mi_72hr_ob_re %>%
  mutate(diff = ob_species_cpua - nefsc_species_cpua,
         log_ob_species_cpua = log(ob_species_cpua), 
         log_nefsc_species_cpua = log(nefsc_species_cpua), 
         diff_of_logs = log_ob_species_cpua - log_nefsc_species_cpua)

#looking at the boxplot and histograms of the difference between CPUA
box.plot_diff(plaice_paired_tows_5mi_72hr_ob_re)
hist_kh_diff(plaice_paired_tows_5mi_72hr_ob_re)

#looking at the boxplot and histograms of the diff_of_logs
box.plot_diff_log(plaice_paired_tows_5mi_72hr_ob_re)
hist_kh_diff_log(plaice_paired_tows_5mi_72hr_ob_re)

#assumptions of normality and equal variance are met with the log transformed data, 
#so the t-test was conducted with the log-transformed data

plaice_ob_ttest <- t.test(plaice_paired_tows_5mi_72hr_ob_re$log_ob_species_cpua, 
                       plaice_paired_tows_5mi_72hr_ob_re$log_nefsc_species_cpua, 
                       paired = TRUE)
plaice_ob_ttest


#back transform the estimate
exp(plaice_ob_ttest$estimate)
exp(plaice_ob_ttest$conf.int)

```

#### Model Run 
```{r, message = FALSE, warning = FALSE}
#AMERICAN PLAICE 
plaicem <- fit.models(plaice_paired_tows_5mi_72hr_ob_re)
compare.models(plaicem)


#storing the optimal model and plotting the diagnostics
plaicem_ob_optimal <- glm(relative_efficiency ~ trawl_type + mgmt_area, 
                          family = binomial, data = plaice_paired_tows_5mi_72hr_ob_re)

par(mfrow=c(2,2))
plot(plaicem_ob_optimal)

summary(plaicem_ob_optimal)

#back transform the estimates into an odds-ratio 
exp(cbind(OR = coef(plaicem_ob_optimal), confint(plaicem_ob_optimal)))

#look at the component residual plots 
crPlots(plaicem_ob_optimal)


# Extract the fitted and predicted values 
plaice_paired_tows_5mi_72hr_ob_re$predict <- predict(plaicem_ob_optimal)
plaice_paired_tows_5mi_72hr_ob_re$fitted <- fitted(plaicem_ob_optimal)

#predicted vs observed values 
plaice_paired_tows_5mi_72hr_ob_re %>%
  ggplot(aes(x = fitted, 
             y = relative_efficiency)) + 
  geom_point() + 
  geom_abline(intercept=0, slope=1) +
  xlim(0,1) + 
  ylim(0,1) + 
  labs(x='Predicted Values', y='Actual Values', title='Predicted vs. Actual Values')



#getting final RE estimate 
plaice_paired_tows_5mi_72hr_ob_re %>%
  group_by(trawl_type) %>%
  summarise(mean(fitted), n = n())

plaice_paired_tows_5mi_72hr_ob_re %>%
  summarise(mean(fitted), n = n())

#plot of trawl type and relative efficiency estimates from the model and the mean for each trawl type 
plaice_paired_tows_5mi_72hr_ob_re %>%
  ggplot(aes(x = trawl_type, 
             y = fitted)) + 
  geom_jitter() + 
  stat_summary(
    geom = "point",
    fun = "mean",
    col = "black",
    size = 3,
    shape = 24,
    fill = "red"
  ) + 
  labs(x = "Trawl Type", y = "Fitted Values of Relative Efficiency") + 
  geom_hline(yintercept = 0.5985181, linetype = "dashed", color = "red") + 
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "black") + 
  scale_x_discrete(labels=c("1" = "Groundfish Trawls", "2" = "Flatfish Trawls",
                              "3" = "Separator Trawls", "4" = "Eliminator Trawls")) + 
  coord_flip()


#plotting effects of each variable on RE
plot(allEffects(plaicem_ob_optimal))

```

## Winter Flounder
#### Exploratory Plots 
```{r}
#Looking at the cpua for the paired tows for each species 
winterfl_paired_tows_5mi_72hr_ob_re %>%
  ggplot() + 
  geom_bar(aes(x = trip_haul_ID, y = ob_species_cpua, fill = "Observer"), stat = "identity") + 
  geom_bar(aes(x = trip_haul_ID, y = -nefsc_species_cpua, fill = "NEFSC"), stat = "identity") + 
  labs(x = "Tow Number", y = CPUA_label, 
       title = "Comparison of CPUA for Winter Flounder", 
       subtitle = "Pairs within 5 mi and 72 hrs") + 
  scale_fill_manual(name = "",
                    values = c("Observer" = "red", "NEFSC" = "blue"), 
                    labels = c("Observer", "NEFSC")) + 
  theme_classic() + 
  theme(axis.text.x=element_blank())


#Looking at the relative efficiency of the study fleet tows compared to the nefsc survey 
winterfl_paired_tows_5mi_72hr_ob_re %>%
  ggplot() +
  geom_histogram(aes(x = relative_efficiency), bins = 100, color = "black", fill = "white") + 
  geom_vline(aes(xintercept = 0.5),
            color = "black", linetype = "dashed", size = 1) + 
  geom_vline(aes(xintercept = mean(relative_efficiency)),
            color = "red", linetype = "dashed", size = 1) + 
  labs(x = "Relative Efficiency", y = "Count", 
       title = "Histogram of Relative Efficiency for Winter Flounder", 
       subtitle = "Pairs within 5 mi and 72 hrs")


#Map of the matched tows 
winterfl_paired_tows_5mi_72hr_ob_re %>%
  ggplot() + 
  geom_sf(data = nefsc_strata, fill = "grey") +
  geom_polygon(data = NEUS, aes(x=long, y = lat, group = group), fill = "darkgreen",  
               color="black",inherit.aes = FALSE)  +
  geom_point(data = winterfl_paired_tows_5mi_72hr_ob_re, aes(x = END_TOW_LON.x,y = END_TOW_LAT.x, color = "NEFSC")) +
  geom_point(data = winterfl_paired_tows_5mi_72hr_ob_re, aes(x = END_TOW_LON.y,y = END_TOW_LAT.y, color = "Observer")) +
  
  # geom_segment(data = paired_tows_1mi_24hr, aes(x = START_TOW_LON.x, xend = END_TOW_LON.x,
  #                                               y = START_TOW_LAT.x, yend = END_TOW_LAT.x)) +
  coord_sf(ylim = c(39, 44),  xlim = c(-74, -66)) + 
  scale_colour_manual("", breaks = c("Observer", "NEFSC"), values = c("red", "blue")) +
  labs(title = "Map of Matched Observer and NEFSC Tows for Winter Flounder", subtitle = "within 5 mi and 72 hrs")



#looking at scatterplot of CPUAs 
winterfl_paired_tows_5mi_72hr_ob_re %>%
  ggplot(aes(x = ob_species_cpua, 
             y = nefsc_species_cpua)) + 
  geom_point() + 
  geom_abline(intercept = 0, slope = 1) +
  labs(x = 'Observer CPUA', y = 'NEFSC CPUA', title = '')

```


#### T-test
```{r}
#looking at the boxplot and histograms of the catch per unit area 
box.plot(winterfl_paired_tows_5mi_72hr_ob_re)
hist_kh(winterfl_paired_tows_5mi_72hr_ob_re)

#log-transforming the data
winterfl_paired_tows_5mi_72hr_ob_re <- winterfl_paired_tows_5mi_72hr_ob_re %>%
  mutate(diff = ob_species_cpua - nefsc_species_cpua,
         log_ob_species_cpua = log(ob_species_cpua), 
         log_nefsc_species_cpua = log(nefsc_species_cpua), 
         diff_of_logs = log_ob_species_cpua - log_nefsc_species_cpua)

#looking at the boxplot and histograms of the difference between CPUA
box.plot_diff(winterfl_paired_tows_5mi_72hr_ob_re)
hist_kh_diff(winterfl_paired_tows_5mi_72hr_ob_re)

# #looking at the boxplot and histograms of the diff_of_logs
# box.plot_diff_log(winterfl_paired_tows_5mi_72hr_ob_re)
# hist_kh_diff_log(winterfl_paired_tows_5mi_72hr_ob_re)

#assumptions of normality and equal variance are met with the raw data, 
#so the t-test was conducted with the raw CPUA data

winterfl_ob_ttest <- t.test(winterfl_paired_tows_5mi_72hr_ob_re$ob_species_cpua, 
                            winterfl_paired_tows_5mi_72hr_ob_re$nefsc_species_cpua, 
                            paired = TRUE)
winterfl_ob_ttest


# #back transform the estimate - NOT NEEDED BECAUSE ASSUMPTIONS WERE MET W RAW DATA
# exp(winterfl_ob_ttest$estimate)
# exp(winterfl_ob_ttest$conf.int)

```

#### Model Run 
```{r, message = FALSE, warning = FALSE}
#WINTER FLOUNDER 
winterflm <- fit.models(winterfl_paired_tows_5mi_72hr_ob_re)
compare.models(winterflm)


#storing the optimal model and plotting the diagnostics
winterflm_ob_optimal <- glm(relative_efficiency ~ trawl_type + season + BOTTEMP, 
                            family = binomial, data = winterfl_paired_tows_5mi_72hr_ob_re)

par(mfrow=c(2,2))
plot(winterflm_ob_optimal)

summary(winterflm_ob_optimal)

#back transform the estimates into an odds-ratio 
exp(cbind(OR = coef(winterflm_ob_optimal), confint(winterflm_ob_optimal)))


#look at the component residual plots 
crPlots(winterflm_ob_optimal)


# Extract the fitted and predicted values 
winterfl_paired_tows_5mi_72hr_ob_re$predict <- predict(winterflm_ob_optimal)
winterfl_paired_tows_5mi_72hr_ob_re$fitted <- fitted(winterflm_ob_optimal)

#predicted vs observed values 
winterfl_paired_tows_5mi_72hr_ob_re %>%
  ggplot(aes(x = fitted, 
             y = relative_efficiency)) + 
  geom_point() + 
  geom_abline(intercept=0, slope=1) +
  xlim(0,1) + 
  ylim(0,1) + 
  labs(x='Predicted Values', y='Actual Values', title='Predicted vs. Actual Values')



#getting final RE estimate 
winterfl_paired_tows_5mi_72hr_ob_re %>%
  group_by(trawl_type) %>%
  summarise(mean(fitted), n = n())

winterfl_paired_tows_5mi_72hr_ob_re %>%
  summarise(mean(fitted), n = n())

#plot of trawl type and relative efficiency estimates from the model and the mean for each trawl type 
winterfl_paired_tows_5mi_72hr_ob_re %>%
  ggplot(aes(x = trawl_type, 
             y = fitted)) + 
  geom_jitter() + 
  stat_summary(
    geom = "point",
    fun = "mean",
    col = "black",
    size = 3,
    shape = 24,
    fill = "red"
  ) + 
  labs(x = "Trawl Type", y = "Fitted Values of Relative Efficiency") + 
  geom_hline(yintercept = 0.5122059, linetype = "dashed", color = "red") + 
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "black") + 
  scale_x_discrete(labels=c("1" = "Groundfish Trawls", "2" = "Flatfish Trawls",
                              "3" = "Separator Trawls", "4" = "Eliminator Trawls")) + 
  coord_flip()

#plotting effects of each variable on RE
plot(allEffects(winterflm_ob_optimal))

```

## Monkfish 
#### Exploratory Plots 
```{r}
#Looking at the cpua for the paired tows for each species 
monkfish_paired_tows_5mi_72hr_ob_re %>%
  ggplot() + 
  geom_bar(aes(x = trip_haul_ID, y = ob_species_cpua, fill = "Observer"), stat = "identity") + 
  geom_bar(aes(x = trip_haul_ID, y = -nefsc_species_cpua, fill = "NEFSC"), stat = "identity") + 
  labs(x = "Tow Number", y = "CPUA (lbs/km2)", 
       title = "Comparison of CPUA for Monkfish", 
       subtitle = "Pairs within 5 mi and 72 hrs") + 
  scale_fill_manual(name = "",
                    values = c("Observer" = "red", "NEFSC" = "blue"), 
                    labels = c("Observer", "NEFSC")) + 
  theme_classic() + 
  theme(axis.text.x=element_blank())


#Looking at the relative efficiency of the study fleet tows compared to the nefsc survey 
monkfish_paired_tows_5mi_72hr_ob_re %>%
  ggplot() +
  geom_histogram(aes(x = relative_efficiency), bins = 100, color = "black", fill = "white") + 
  geom_vline(aes(xintercept = 0.5),
            color = "black", linetype = "dashed", size = 1) + 
  geom_vline(aes(xintercept = mean(relative_efficiency)),
            color = "red", linetype = "dashed", size = 1) + 
  labs(x = "Relative Efficiency", y = "Count", 
       title = "Histogram of Relative Efficiency for Monkfish", 
       subtitle = "Pairs within 5 mi and 72 hrs")


#Map of the matched tows 
monkfish_paired_tows_5mi_72hr_ob_re %>%
  ggplot() + 
  geom_sf(data = nefsc_strata, fill = "grey") +
  geom_polygon(data = NEUS, aes(x=long, y = lat, group = group), fill = "darkgreen",  
               color="black",inherit.aes = FALSE)  +
  geom_point(data = monkfish_paired_tows_5mi_72hr_ob_re, aes(x = END_TOW_LON.x,y = END_TOW_LAT.x, color = "NEFSC")) +
  geom_point(data = monkfish_paired_tows_5mi_72hr_ob_re, aes(x = END_TOW_LON.y,y = END_TOW_LAT.y, color = "Observer")) +
  
  # geom_segment(data = paired_tows_1mi_24hr, aes(x = START_TOW_LON.x, xend = END_TOW_LON.x,
  #                                               y = START_TOW_LAT.x, yend = END_TOW_LAT.x)) +
  coord_sf(ylim = c(39, 44),  xlim = c(-74, -66)) + 
  scale_colour_manual("", breaks = c("Observer", "NEFSC"), values = c("red", "blue")) +
  labs(title = "Map of Matched Observer and NEFSC Tows for Monkfish", subtitle = "within 5 mi and 72 hrs")



#looking at scatterplot of CPUAs 
monkfish_paired_tows_5mi_72hr_ob_re %>%
  ggplot(aes(x = ob_species_cpua, 
             y = nefsc_species_cpua)) + 
  geom_point() + 
  geom_abline(intercept = 0, slope = 1) +
  labs(x = 'Observer CPUA', y = 'NEFSC CPUA', title = '')


```


#### T-test
```{r}
#looking at the boxplot and histograms of the catch per unit area 
box.plot(monkfish_paired_tows_5mi_72hr_ob_re)
hist_kh(monkfish_paired_tows_5mi_72hr_ob_re)

#log-transforming the data
monkfish_paired_tows_5mi_72hr_ob_re <- monkfish_paired_tows_5mi_72hr_ob_re %>%
  mutate(diff = ob_species_cpua - nefsc_species_cpua,
         log_ob_species_cpua = log(ob_species_cpua), 
         log_nefsc_species_cpua = log(nefsc_species_cpua), 
         diff_of_logs = log_ob_species_cpua - log_nefsc_species_cpua)

#looking at the boxplot and histograms of the difference between CPUA
box.plot_diff(monkfish_paired_tows_5mi_72hr_ob_re)
hist_kh_diff(monkfish_paired_tows_5mi_72hr_ob_re)

#looking at the boxplot and histograms of the diff_of_logs
box.plot_diff_log(monkfish_paired_tows_5mi_72hr_ob_re)
hist_kh_diff_log(monkfish_paired_tows_5mi_72hr_ob_re)

#assumptions of normality and equal variance are met with the log transformed data, 
#so the t-test was conducted with the log-transformed data

monkfish_ob_ttest <- t.test(monkfish_paired_tows_5mi_72hr_ob_re$log_ob_species_cpua, 
                         monkfish_paired_tows_5mi_72hr_ob_re$log_nefsc_species_cpua, 
                         paired = TRUE)
monkfish_ob_ttest

#back transform the estimate
exp(monkfish_ob_ttest$estimate)
exp(monkfish_ob_ttest$conf.int)

```

#### Model Run 
```{r, message = FALSE, warning = FALSE}
#NOT SURE IF ITS FAIR TO RUN THIS ANALYSIS ON SUCH A SMALL SAMPLE SIZE (n=11)
#MONKFISH 
monkfishm <- fit.models(monkfish_paired_tows_5mi_72hr_ob_re)
compare.models(monkfishm)


#storing the optimal model and plotting the diagnostics
monkfishm_ob_optimal <- glm(relative_efficiency ~ trawl_type + season + AVGDEPTH, 
                            family = binomial, data = monkfish_paired_tows_5mi_72hr_ob_re)

par(mfrow=c(2,2))
plot(monkfishm_ob_optimal)

summary(monkfishm_ob_optimal)

#back transform the estimates into an odds-ratio 
exp(cbind(OR = coef(monkfishm_ob_optimal), confint(monkfishm_ob_optimal)))

#look at the component residual plots 
crPlots(monkfishm_ob_optimal)


# Extract the fitted and predicted values 
monkfish_paired_tows_5mi_72hr_ob_re$predict <- predict(monkfishm_ob_optimal)
monkfish_paired_tows_5mi_72hr_ob_re$fitted <- fitted(monkfishm_ob_optimal)

#predicted vs observed values 
monkfish_paired_tows_5mi_72hr_ob_re %>%
  ggplot(aes(x = fitted, 
             y = relative_efficiency)) + 
  geom_point() + 
  geom_abline(intercept=0, slope=1) +
  xlim(0,1) + 
  ylim(0,1) + 
  labs(x='Predicted Values', y='Actual Values', title='Predicted vs. Actual Values')



#getting final RE estimate 
monkfish_paired_tows_5mi_72hr_ob_re %>%
  group_by(trawl_type) %>%
  summarise(mean(fitted), n = n())

monkfish_paired_tows_5mi_72hr_ob_re %>%
  summarise(mean(fitted), n = n())

#plot of trawl type and relative efficiency estimates from the model and the mean for each trawl type 
monkfish_paired_tows_5mi_72hr_ob_re %>%
  ggplot(aes(x = trawl_type, 
             y = fitted)) + 
  geom_jitter() + 
  stat_summary(
    geom = "point",
    fun = "mean",
    col = "black",
    size = 3,
    shape = 24,
    fill = "red"
  ) + 
  labs(x = "Trawl Type", y = "Fitted Values of Relative Efficiency") + 
  geom_hline(yintercept = 0.5122059, linetype = "dashed", color = "red") + 
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "black") + 
  scale_x_discrete(labels=c("1" = "Groundfish Trawls", "2" = "Flatfish Trawls",
                              "3" = "Separator Trawls", "4" = "Eliminator Trawls")) + 
  coord_flip()


#plotting effects of each variable on RE
plot(allEffects(monkfishm_ob_optimal))

```

# Playing Around 
```{r, eval=FALSE}
#COD
cod_paired_tows_5mi_72hr_ob_re
codm_ob_optimal

hist(cod_paired_tows_5mi_72hr_ob_re$relative_efficiency)


cod_paired_tows_5mi_72hr_ob_re %>%
  ggplot() + 
  geom_boxplot(aes(y = relative_efficiency, x = trawl_type))


codm_ob_optimal_p <- predict.glm(codm_ob_optimal)

effect_plot(codm_ob_optimal, pred = trawl_type, interval = TRUE, 
            plot.points = TRUE, jitter = 0.05)



cod_paired_tows_5mi_72hr_ob_re %>%
  ggplot() + 
  geom_point(aes(x = cod_paired_tows_5mi_72hr_ob_re$relative_efficiency,
                 y = predict(codm_ob_optimal), shape = trawl_type)) + 
  scale_shape_discrete(name = "Trawl Category", 
                       labels = c("Generic Groundfish Trawls", 
                                  "Flatfish Trawls", 
                                  "Separator Trawls",
                                  "Other/Unknown Trawls")) + 
  labs(x = "Actual Values", y = "Predicted Values") + 
  theme_classic()
  


cod_paired_tows_5mi_72hr_ob_re %>%
  ggplot() + 
  geom_point(aes(x = relative_efficiency,
                 y = predict(codm_ob_optimal), shape = trawl_type)) + 
  labs(title = "Predicted v Actual Values", 
       subtitle = "Cod - Pairs within 5 mi and 72 hrs",
       x = "Actual Values", y = "Predicted Values") + 
  facet_wrap(~ trawl_type, 
             labeller = as_labeller(c("1" = "Generic Groundfish Trawls", 
                                      "2" = "Flatfish Trawls", 
                                      "3" = "Separator Trawls",
                                      "5" = "Other/Unknown Trawls"))) + 
  guides(shape = FALSE) + 
  theme_classic() 













######### looking at haddock cause it's results don't make any sense
haddockm_ob_optimal <- glm(relative_efficiency ~ mgmt_area + trawl_type + AVGDEPTH + BOTTEMP, family = binomial, data = haddock_paired_tows_5mi_72hr_ob_re)

par(mfrow=c(2,2))
plot(haddockm_ob_optimal)

summary(haddockm_ob_optimal)

#back transform the estimates into an odds-ratio 
exp(cbind(OR = coef(haddockm_ob_optimal), confint(haddockm_ob_optimal)))



#creating a model with just trawl type
haddockm_ob_optimal1 <- glm(relative_efficiency ~ trawl_type + BOT, family = binomial, data = haddock_paired_tows_5mi_72hr_ob_re)

par(mfrow=c(2,2))
plot(haddockm_ob_optimal1)

summary(haddockm_ob_optimal1)

#back transform the estimates into an odds-ratio 
exp(cbind(OR = coef(haddockm_ob_optimal1), confint(haddockm_ob_optimal1)))



#predicted v actual for haddock
haddock_paired_tows_5mi_72hr_ob_re %>%
  ggplot() + 
  geom_point(aes(x = relative_efficiency,
                 y = predict(haddockm_ob_optimal), shape = trawl_type)) + 
  labs(title = "Predicted v Actual Values", 
       subtitle = "Haddock - Pairs within 5 mi and 72 hrs",
       x = "Actual Values", y = "Predicted Values") + 
  facet_wrap(~ trawl_type, 
             labeller = as_labeller(c("1" = "Generic Groundfish Trawls", 
                                      "2" = "Flatfish Trawls", 
                                      "3" = "Separator Trawls",
                                      "5" = "Other/Unknown Trawls"))) + 
  guides(shape = FALSE) + 
  theme_classic() 



haddock_paired_tows_5mi_72hr_ob_re %>%
  select(trawl_type, relative_efficiency, nefsc_species_cpua, ob_species_cpua)

haddock_paired_tows_5mi_72hr_ob_re %>%
  ggplot() + 
  geom_point(aes(x = trawl_type, y = relative_efficiency))

haddock_paired_tows_5mi_72hr_ob_re %>%
  count(trawl_type)









#plotting the matches for 5 mi and 3 days 
paired_tows_5mi_72hr_ob_re %>%
  ggplot() + 
  geom_sf(data = nefsc_strata, fill = "grey") +
  geom_polygon(data = NEUS, aes(x=long, y = lat, group = group), fill = "darkgreen",  
               color="black",inherit.aes = FALSE)  +
  geom_point(data = paired_tows_5mi_72hr_ob_re, aes(x = END_TOW_LON.x,y = END_TOW_LAT.x, color = "NEFSC")) +
  geom_point(data = paired_tows_5mi_72hr_ob_re, aes(x = END_TOW_LON.y,y = END_TOW_LAT.y, color = "Observer")) +
  
  # geom_segment(data = paired_tows_1mi_24hr, aes(x = START_TOW_LON.x, xend = END_TOW_LON.x,
  #                                               y = START_TOW_LAT.x, yend = END_TOW_LAT.x)) +
  coord_sf(ylim = c(39, 44),  xlim = c(-74, -66)) + 
  scale_colour_manual("", breaks = c("NEFSC", "Observer"), values = c("red", "blue")) +
  labs(title = "Observer tows Matched to NEFSC tows", subtitle = "within 5 mi and 72 hrs")

```

